<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.edaisong.api.dao.inter.IBusinessClienterRelationDao" >
  <select id="getBusinessBindClienterQty" resultType="int" parameterType="int">
  	SELECT COUNT(1) FROM BusinessClienterRelation bcr WITH(NOLOCK) 
  	WHERE bcr.IsBind = 1 AND bcr.IsEnable=1 AND BusinessId=#{businessId,jdbcType=INTEGER};
  </select>
  
  <select id="getClienterBindBusinessQty" resultType="int" parameterType="int">
  	SELECT COUNT(1) FROM BusinessClienterRelation bcr WITH(NOLOCK) 
  	WHERE bcr.IsBind = 1 AND bcr.IsEnable=1 AND ClienterId=#{clienterId,jdbcType=INTEGER};
  </select>
  
  <sql id="getBusinessClienterRelationListWhere">
  	bcr.IsEnable=1
  	<if test="businessID != 0" >
  		AND bcr.[BusinessId]=${businessID}
  	</if>
  	<if test="search != null and search!=''">
	    and (c.TrueName=''${search}''
		or c.PhoneNo=''${search}'')
		</if>
  </sql>
  
  <!-- 商户绑定骑士列表 -->
    <select id="getBusinessClienterRelationList" resultType="com.edaisong.entity.domain.BusinessClienterRelationModel" parameterType="com.edaisong.entity.req.PagedCustomerSearchReq"  statementType="CALLABLE" >
  	{call Sp_CustomPage2015_V1(
	' bcr.isbind desc,bcr.auditstatus ',
	' bcr.Id id,c.TrueName trueName,c.phoneNo,bcr.auditStatus,bcr.createTime,bcr.isBind,bcr.createBy,bcr.updateBy,bcr.updateTime,bcr.businessId,bcr.clienterId,bcr.isEnable ',
	' BusinessClienterRelation bcr WITH(NOLOCK) JOIN dbo.clienter c WITH(NOLOCK) ON bcr.ClienterId=c.Id ',
	' <include refid="getBusinessClienterRelationListWhere" /> ',
	#{pageSize,mode=IN,jdbcType=INTEGER},
	#{currentPage,mode=IN,jdbcType=INTEGER}
	,1,
	#{totalRecord,mode=OUT,jdbcType=INTEGER},
	#{totalPage,mode=OUT,jdbcType=INTEGER}
	)}
  </select>
  
  <sql id="modifyClienterBindOutput">
  	OUTPUT
	  Inserted.BusinessId,
	  Inserted.ClienterId,
	  ${optId},
	  '${optName}',
	  getdate(),
	  '${remark}'
	INTO ClienterBindOptionLog
	  ( BusinessId
	   ,ClienterId
	   ,OptId
	   ,OptName
	   ,InsertTime
	   ,Remark)
  </sql>
  
  <!-- 修改骑士绑定  add by pengyi 20150901 -->
  <update id="modifyClienterBind" parameterType="com.edaisong.entity.req.ClienterBindOptionReq">
  	update bcr
	set    bcr.IsBind=#{isBind,jdbcType=INTEGER},
	bcr.UpdateBy=#{optName,jdbcType=NVARCHAR},
	bcr.UpdateTime=getdate() ,
	bcr.IsEnable=1 ,
	bcr.AuditStatus=#{auditStatus}
	<include refid="modifyClienterBindOutput"></include>
	from BusinessClienterRelation bcr WITH ( ROWLOCK )
	where bcr.BusinessId=${businessId} AND bcr.ClienterId=${clienterId} 
    <if test="isBind == 0" >
  		AND isBind = 1
  	</if>
  	<if test="isBind == 1" >
  		AND isBind = 0
  	</if>

  </update>
  
    <!-- 移除骑士绑定  add by pengyi 20150901 -->
  <update id="removeclienterbind" parameterType="com.edaisong.entity.req.ClienterBindOptionReq">
  	update bcr
	set    bcr.IsEnable=0,bcr.isbind=0,bcr.auditstatus=2,
	bcr.UpdateBy=#{optName,jdbcType=NVARCHAR},
	bcr.UpdateTime=getdate() 
	<include refid="modifyClienterBindOutput"></include>
	from BusinessClienterRelation bcr WITH ( ROWLOCK )
	where bcr.BusinessId=${businessId} AND bcr.ClienterId=${clienterId};
  </update>
  
  <select id="checkHaveBind" resultType="int" parameterType="com.edaisong.entity.req.ClienterBindOptionReq">
  	SELECT COUNT(1) FROM BusinessClienterRelation bcr WITH(NOLOCK) 
  	WHERE  bcr.isBind=1 and bcr.IsEnable=1  AND BusinessId=#{businessId,jdbcType=INTEGER} AND ClienterId=#{clienterId,jdbcType=INTEGER};
  </select>
  
  <insert id="addClienterBind" parameterType="com.edaisong.entity.req.ClienterBindOptionReq">
  	delete BusinessClienterRelation where BusinessId=#{businessId,jdbcType=INTEGER}
  	and ClienterId=#{clienterId,jdbcType=INTEGER} 
  	INSERT INTO [BusinessClienterRelation]
           ([BusinessId]
           ,[ClienterId]
           ,[CreateBy]
           ,[UpdateBy],[IsEnable],[isBind],[AuditStatus])
	OUTPUT
	  Inserted.BusinessId,
	  Inserted.ClienterId,
	  #{optId,jdbcType=INTEGER},
	  #{optName,jdbcType=NVARCHAR},
	  getdate(),
	  #{remark,jdbcType=NVARCHAR}
	INTO ClienterBindOptionLog
	  ( BusinessId
	   ,ClienterId
	   ,OptId
	   ,OptName
	   ,InsertTime
	   ,Remark)
	Values(
		#{businessId,jdbcType=INTEGER},
		#{clienterId,jdbcType=INTEGER},
        #{optName,jdbcType=NVARCHAR},
        #{optName,jdbcType=NVARCHAR},
        1,
        #{isBind,jdbcType=INTEGER},
        #{auditStatus}
	);
  </insert>
  
  <select id="getDetails" resultType="com.edaisong.entity.BusinessClienterRelation" parameterType="java.util.Map">
  	select id,businessid,clienterid,isenable,createby,createtime,updateby,updatetime,isbind
 from   dbo.[BusinessClienterRelation] (nolock ) 
 where IsEnable=1 and  BusinessId=#{businessId,jdbcType=INTEGER}  and ClienterId=#{ClienterId,jdbcType=INTEGER}
  </select>
    <select id="getByRelationId" resultType="com.edaisong.entity.BusinessClienterRelation" parameterType="java.lang.Long">
  	select id,businessid,clienterid,isenable,createby,createtime,updateby,updatetime,isbind
 from   dbo.[BusinessClienterRelation] (nolock ) 
 where id=#{businessId,jdbcType=INTEGER} 
  </select>
  
    <!-- 商戶端 查詢  我的骑士  add by caoheyang 20151103 -->
    <select id="getMyServiceClienters" resultType="com.edaisong.entity.domain.ServiceClienters" 
    parameterType="com.edaisong.entity.req.PagedGetMyServiceClientersReq"  statementType="CALLABLE" >
  	{call Sp_CustomPage2015_V1(
	' a.Id DESC ',
	' a.id as RelationId,a.ClienterId,b.TrueName,b.PhoneNo,b.HeadPhoto ',
	' dbo.BusinessClienterRelation a (nolock) join dbo.clienter b(nolock) on a.ClienterId=b.Id ',
	' <include refid="getMyServiceClientersWhere" /> ',
	#{pageSize,mode=IN,jdbcType=INTEGER},
	#{currentPage,mode=IN,jdbcType=INTEGER}
	,1,
	#{totalRecord,mode=OUT,jdbcType=INTEGER},
	#{totalPage,mode=OUT,jdbcType=INTEGER}
	)}
  </select>
      <!-- 商戶端 查詢  我的骑士  查询条件  add by caoheyang 20151103 -->
    <sql id="getMyServiceClientersWhere">
  	a.IsEnable=1 
  	<if test="businessId != 0" >
  		AND a.[BusinessId]=${businessId}
  	</if>
  	<if test="auditStatus != null ">
	  and a.auditStatus= ${auditStatus} 
		</if> 
  </sql>
      <!-- 商戶端 查詢  我的骑士数量信息  add by caoheyang 20151103 -->
   <select id="getMyServiceClientersCountInfo" resultType="com.edaisong.entity.resp.GetMyServiceClientersResp" 
    parameterType="com.edaisong.entity.req.PagedGetMyServiceClientersReq" >
   select ISNULL(SUM(CASE 
             when AuditStatus=0 and IsBind=0 then 1
              else 0
            end),0) as WaitAduitCount,
        ISNULL(SUM(CASE 
              when AuditStatus=1 and IsBind=1 then 1
              else 0
            end),0) as ServiceCount
 from   dbo.BusinessClienterRelation    a(nolock)
 where  a.IsEnable=1 
 	<if test="businessId != 0" >
  		AND a.[BusinessId]=${businessId}
  	</if>
  </select>
  
  
    <!--商戶端 我的骑士 申请中 同意/拒绝功能  caoheyang  20151103 -->
  <update id="optBindClienter" parameterType="com.edaisong.entity.req.OptBindClienterReq">
  	update bcr
	set    bcr.AuditStatus=#{auditStatus},
	bcr.IsEnable=1,
	bcr.IsBind=#{isBind},
	UpdateBy= '${optName}' ,
    UpdateTime=getdate()
    OUTPUT
	  Inserted.BusinessId,
	  Inserted.ClienterId,
	  ${businessId},
	  '${optName}',
	  getdate(),
	  '${remark}'
	INTO ClienterBindOptionLog
	  ( BusinessId
	   ,ClienterId
	   ,OptId
	   ,OptName
	   ,InsertTime
	   ,Remark)
	from BusinessClienterRelation bcr WITH ( ROWLOCK )
	where bcr.BusinessId=${businessId}  AND bcr.id=${relationId} and  bcr.AuditStatus=0  
  </update>
  <!-- 骑士再次申请绑定商户， 修改绑定关系中的相关状态 记录日志  wangchao -->
 <update id="updateClienterBindRelation" parameterType="com.edaisong.entity.req.ClienterBindOptionReq">
  	update bcr
	set    bcr.AuditStatus=#{auditStatus},
	bcr.IsEnable=#{isEnable},
	bcr.IsBind=#{isBind},
	UpdateBy=${clienterId},
    UpdateTime=getdate()
    OUTPUT
	  Inserted.BusinessId,
	  Inserted.ClienterId,
	  ${clienterId},
	  '${optName}',
	  getdate(),
	  '${remark}'
	INTO ClienterBindOptionLog
	  ( BusinessId
	   ,ClienterId
	   ,OptId
	   ,OptName
	   ,InsertTime
	   ,Remark)
	from BusinessClienterRelation bcr WITH ( ROWLOCK )
	where bcr.BusinessId=${businessId}  AND bcr.ClienterId=${clienterId}  
  </update>
</mapper>