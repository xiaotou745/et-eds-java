<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.edaisong.api.dao.inter.IOrderDao">
	<!-- 商家订单概览信息 可扩展 add by pengyi 20180818 -->
	<resultMap id="businessOrderSummaryResultMap"
		type="com.edaisong.entity.domain.BusinessOrderSummaryModel">
		<result property="unReceive" column="unReceive" jdbcType="INTEGER" />
		<result property="finish" column="finish" jdbcType="INTEGER" />
		<result property="cancel" column="cancel" jdbcType="INTEGER" />
		<result property="pickUp" column="pickUp" jdbcType="INTEGER" />
		<result property="received" column="received" jdbcType="INTEGER" />
		<result property="name" column="name" jdbcType="NVARCHAR" />
		<result property="balancePrice" column="balancePrice" jdbcType="NUMERIC" />
		<result property="lastLoginTime" column="lastLoginTime"
			jdbcType="TIMESTAMP" />
		<result property="city" column="city" jdbcType="NVARCHAR" />
	</resultMap>
	<!-- 商家发单时间统计 可扩展 add by pengyi 20180819 -->
	<resultMap id="busiPubOrderTimeStatisticsResultMap"
		type="com.edaisong.entity.domain.BusiPubOrderTimeStatisticsModel">
		<result property="hour" column="hour" jdbcType="INTEGER" />
		<result property="pubCount" column="pubCount" jdbcType="INTEGER" />
	</resultMap>

	<sql id="Base_Column_List">
	Id, OrderNo, PickUpAddress, PubDate, ReceviceName, RecevicePhoneNo, ReceviceAddress, 
     ActualDoneDate, IsPay, Amount, OrderCommission, DistribSubsidy, WebsiteSubsidy, Remark, 
    Status, clienterId, businessId, ReceviceCity, ReceviceLongitude, ReceviceLatitude, 
    OrderFrom, OriginalOrderId, OriginalOrderNo, Quantity, Weight, ReceiveProvince, ReceiveArea, 
    ReceiveProvinceCode, ReceiveCityCode, ReceiveAreaCode, OrderType, KM, GuoJuQty, LuJuQty, 
    SongCanDate, OrderCount, CommissionRate, Payment, CommissionFormulaMode, Adjustment, 
    BusinessCommission, SettleMoney, DealCount, PickupCode,ReceiveCode, OtherCancelReason, CommissionType, 
    CommissionFixValue, BusinessGroupId, TimeSpan, Invoice, BusinessReceivable, MealsSettleMode, 
    FinishDateLength, FinishAll, RealOrderCommission, IsEnable, DeliveryCompanySettleMoney, 
    DeliveryCompanyID, BaseCommission, IsConsiderDeliveryFee, IsComplain, GroupBusinessId, 
    Platform, PubName, PubPhoneNo,  TakeType,  ProductName,tipAmount,pickuplongitude,pickuplatitude,PubCity,
    IsReceiveCode
	</sql>
	  <select id="selectByPrimaryKey" resultType="com.edaisong.entity.Order" parameterType="java.lang.Integer" >
    select 
      <include refid="Base_Column_List" />
    from [order]  nolock
    where Id = #{id,jdbcType=INTEGER} 
  </select>
	<!-- 自身的字段作为查询条件 查询order 的基础数据 可扩展 CaoHeYang 20150804 -->
	<select id="getOneByCriteria" resultType="com.edaisong.entity.Order" 
		parameterType="com.edaisong.entity.Order">
		select
		<include refid="Base_Column_List" />
		from [order]
		where 1=1
		<if test="id != null">
			and id= #{id,jdbcType=INTEGER}
		</if>
		<if test="orderno != null">
			and orderno= #{orderno,jdbcType=NVARCHAR}
		</if>
		<if test="businessid != null">
			and businessid= #{businessid,jdbcType=INTEGER}
		</if>
		<if test="status != null">
			and status= #{status,jdbcType=INTEGER}
		</if>
	</select>	
		
	<select id="selectIsExistByBusinessId" resultType="com.edaisong.entity.Order" 
		parameterType="com.edaisong.entity.req.OrderReq">
		select
		<include refid="Base_Column_List" />
		from [order]
		where 1=1	
		<if test="businessid != null">
			and businessid= #{businessid,jdbcType=INTEGER}
		</if>
		<if test="timeSpan != null">
			and timeSpan= #{timeSpan,jdbcType=NVARCHAR}
		</if>
	</select>

	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from order
		where Id = #{id,jdbcType=INTEGER}
	</delete>

	<insert id="insertSelective" parameterType="com.edaisong.entity.Order">
		<selectKey resultType="java.lang.Integer" keyProperty="id"
			order="AFTER">
			select @@IDENTITY as id
		</selectKey>

		insert into dbo.[order]
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="orderno != null">
				OrderNo,
			</if>
			<if test="pickupaddress != null">
				PickUpAddress,
			</if>
			<if test="pickuplongitude != null">
				pickuplongitude,
			</if>
			<if test="pickuplatitude != null">
				pickuplatitude,
			</if>
			<if test="pubdate != null">
				PubDate,
			</if>
				<if test="pubcity != null">
				pubcity,
			</if>
			<if test="recevicename != null">
				ReceviceName,
			</if>
			<if test="recevicephoneno != null">
				RecevicePhoneNo,
			</if>
			<if test="receviceaddress != null">
				ReceviceAddress,
			</if>
			<if test="actualdonedate != null">
				ActualDoneDate,
			</if>
			<if test="ispay != null">
				IsPay,
			</if>
			<if test="amount != null">
				Amount,
			</if>
			<if test="ordercommission != null">
				OrderCommission,
			</if>
			<if test="distribsubsidy != null">
				DistribSubsidy,
			</if>
			<if test="websitesubsidy != null">
				WebsiteSubsidy,
			</if>
			<if test="remark != null">
				Remark,
			</if>
			<if test="status != null">
				Status,
			</if>
			<if test="clienterid != null">
				clienterId,
			</if>
			<if test="businessid != null">
				businessId,
			</if>
			<if test="recevicecity != null">
				ReceviceCity,
			</if>
			<if test="recevicelongitude != null">
				ReceviceLongitude,
			</if>
			<if test="recevicelatitude != null">
				ReceviceLatitude,
			</if>
			<if test="orderfrom != null">
				OrderFrom,
			</if>
			<if test="originalorderid != null">
				OriginalOrderId,
			</if>
			<if test="originalorderno != null">
				OriginalOrderNo,
			</if>
			<if test="quantity != null">
				Quantity,
			</if>
			<if test="weight != null">
				Weight,
			</if>
			<if test="receiveprovince != null">
				ReceiveProvince,
			</if>
			<if test="receivearea != null">
				ReceiveArea,
			</if>
			<if test="receiveprovincecode != null">
				ReceiveProvinceCode,
			</if>
			<if test="receivecitycode != null">
				ReceiveCityCode,
			</if>
			<if test="receiveareacode != null">
				ReceiveAreaCode,
			</if>
			<if test="ordertype != null">
				OrderType,
			</if>
			<if test="km != null">
				KM,
			</if>
			<if test="guojuqty != null">
				GuoJuQty,
			</if>
			<if test="lujuqty != null">
				LuJuQty,
			</if>
			<if test="songcandate != null">
				SongCanDate,
			</if>
			<if test="ordercount != null">
				OrderCount,
			</if>
			<if test="commissionrate != null">
				CommissionRate,
			</if>
			<if test="payment != null">
				Payment,
			</if>
			<if test="commissionformulamode != null">
				CommissionFormulaMode,
			</if>
			<if test="adjustment != null">
				Adjustment,
			</if>
			<if test="businesscommission != null">
				BusinessCommission,
			</if>
			<if test="settlemoney != null">
				SettleMoney,
			</if>
			<if test="dealcount != null">
				DealCount,
			</if>
			<if test="pickupcode != null">
				PickupCode,
			</if>
			<if test="receivecode != null">
				ReceiveCode,
			</if>
			<if test="othercancelreason != null">
				OtherCancelReason,
			</if>
			<if test="commissiontype != null">
				CommissionType,
			</if>
			<if test="commissionfixvalue != null">
				CommissionFixValue,
			</if>
			<if test="businessgroupid != null">
				BusinessGroupId,
			</if>
			<if test="timespan != null">
				TimeSpan,
			</if>
			<if test="invoice != null">
				Invoice,
			</if>
			<if test="businessreceivable != null">
				BusinessReceivable,
			</if>
			<if test="mealssettlemode != null">
				MealsSettleMode,
			</if>
			<if test="finishdatelength != null">
				FinishDateLength,
			</if>
			<if test="finishall != null">
				FinishAll,
			</if>
			<if test="realordercommission != null">
				RealOrderCommission,
			</if>
			<if test="groupbusinessid != null">
				groupbusinessid,
			</if>
			<if test="basecommission != null">
				basecommission,
			</if>
			<if test="platform != null">
				platform,
			</if>
			 <if test="pubname != null" >
             PubName,
            </if>
            <if test="pubphoneno != null" >
        PubPhoneNo,
      </if>    
      <if test="taketype != null" >
        TakeType,
      </if>    
      <if test="productname != null" >
        ProductName,
      </if>
      <if test="tipamount != null">
				TipAmount,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="orderno != null">
				#{orderno,jdbcType=NVARCHAR},
			</if>	
			<if test="pickupaddress != null">
				#{pickupaddress,jdbcType=NVARCHAR},
			</if>
			<if test="pickuplongitude != null">
				#{pickuplongitude,jdbcType=DOUBLE},
			</if>
			<if test="pickuplatitude != null">
				#{pickuplatitude,jdbcType=DOUBLE},
			</if>
			<if test="pubdate != null">
				getdate(),
			</if>
			<if test="pubcity != null">
				#{pubcity,jdbcType=NVARCHAR},
			</if>
			<if test="recevicename != null">
				#{recevicename,jdbcType=NVARCHAR},
			</if>
			<if test="recevicephoneno != null">
				#{recevicephoneno,jdbcType=NVARCHAR},
			</if>
			<if test="receviceaddress != null">
				#{receviceaddress,jdbcType=NVARCHAR},
			</if>
			<if test="actualdonedate != null">
				#{actualdonedate,jdbcType=TIMESTAMP},
			</if>
			<if test="ispay != null">
				#{ispay,jdbcType=BIT},
			</if>
			<if test="amount != null">
				#{amount,jdbcType=NUMERIC},
			</if>
			<if test="ordercommission != null">
				#{ordercommission,jdbcType=NUMERIC},
			</if>
			<if test="distribsubsidy != null">
				#{distribsubsidy,jdbcType=NUMERIC},
			</if>
			<if test="websitesubsidy != null">
				#{websitesubsidy,jdbcType=NUMERIC},
			</if>
			<if test="remark != null">
				#{remark,jdbcType=NVARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=TINYINT},
			</if>
			<if test="clienterid != null">
				#{clienterid,jdbcType=INTEGER},
			</if>
			<if test="businessid != null">
				#{businessid,jdbcType=INTEGER},
			</if>
			<if test="recevicecity != null">
				#{recevicecity,jdbcType=NVARCHAR},
			</if>
			<if test="recevicelongitude != null">
				#{recevicelongitude,jdbcType=DOUBLE},
			</if>
			<if test="recevicelatitude != null">
				#{recevicelatitude,jdbcType=DOUBLE},
			</if>
			<if test="orderfrom != null">
				#{orderfrom,jdbcType=INTEGER},
			</if>
			<if test="originalorderid != null">
				#{originalorderid,jdbcType=BIGINT},
			</if>
			<if test="originalorderno != null">
				#{originalorderno,jdbcType=NVARCHAR},
			</if>
			<if test="quantity != null">
				#{quantity,jdbcType=INTEGER},
			</if>
			<if test="weight != null">
				#{weight,jdbcType=NUMERIC},
			</if>
			<if test="receiveprovince != null">
				#{receiveprovince,jdbcType=NVARCHAR},
			</if>
			<if test="receivearea != null">
				#{receivearea,jdbcType=NVARCHAR},
			</if>
			<if test="receiveprovincecode != null">
				#{receiveprovincecode,jdbcType=NVARCHAR},
			</if>
			<if test="receivecitycode != null">
				#{receivecitycode,jdbcType=NVARCHAR},
			</if>
			<if test="receiveareacode != null">
				#{receiveareacode,jdbcType=NVARCHAR},
			</if>
			<if test="ordertype != null">
				#{ordertype,jdbcType=INTEGER},
			</if>
			<if test="km != null">
				#{km,jdbcType=DOUBLE},
			</if>
			<if test="guojuqty != null">
				#{guojuqty,jdbcType=INTEGER},
			</if>
			<if test="lujuqty != null">
				#{lujuqty,jdbcType=INTEGER},
			</if>
			<if test="songcandate != null">
				#{songcandate,jdbcType=TIMESTAMP},
			</if>
			<if test="ordercount != null">
				#{ordercount,jdbcType=INTEGER},
			</if>
			<if test="commissionrate != null">
				#{commissionrate,jdbcType=NUMERIC},
			</if>
			<if test="payment != null">
				#{payment,jdbcType=INTEGER},
			</if>
			<if test="commissionformulamode != null">
				#{commissionformulamode,jdbcType=INTEGER},
			</if>
			<if test="adjustment != null">
				#{adjustment,jdbcType=DECIMAL},
			</if>
			<if test="businesscommission != null">
				#{businesscommission,jdbcType=DECIMAL},
			</if>
			<if test="settlemoney != null">
				#{settlemoney,jdbcType=NUMERIC},
			</if>
			<if test="dealcount != null">
				#{dealcount,jdbcType=INTEGER},
			</if>
			<if test="pickupcode != null">
				#{pickupcode,jdbcType=VARCHAR},
			</if>
				<if test="receivecode != null">
				#{receivecode,jdbcType=VARCHAR},
			</if>
			<if test="othercancelreason != null">
				#{othercancelreason,jdbcType=NVARCHAR},
			</if>
			<if test="commissiontype != null">
				#{commissiontype,jdbcType=INTEGER},
			</if>
			<if test="commissionfixvalue != null">
				#{commissionfixvalue,jdbcType=DECIMAL},
			</if>
			<if test="businessgroupid != null">
				#{businessgroupid,jdbcType=INTEGER},
			</if>
			<if test="timespan != null">
				#{timespan,jdbcType=NVARCHAR},
			</if>
			<if test="invoice != null">
				#{invoice,jdbcType=NVARCHAR},
			</if>
			<if test="businessreceivable != null">
				#{businessreceivable,jdbcType=DECIMAL},
			</if>
			<if test="mealssettlemode != null">
				#{mealssettlemode,jdbcType=INTEGER},
			</if>
			<if test="finishdatelength != null">
				#{finishdatelength,jdbcType=INTEGER},
			</if>
			<if test="finishall != null">
				#{finishall,jdbcType=INTEGER},
			</if>
			<if test="realordercommission != null">
				#{realordercommission,jdbcType=NUMERIC},
			</if>
			<if test="groupbusinessid != null">
				#{groupbusinessid,jdbcType=NUMERIC},
			</if>
			<if test="basecommission != null">
				#{basecommission,jdbcType=NUMERIC},
			</if>
			<if test="platform != null">
				#{platform,jdbcType=INTEGER},
			</if>
					<if test="pubname != null" >
        #{pubname,jdbcType=NVARCHAR},
      </if>
			 <if test="pubphoneno != null" >
        #{pubphoneno,jdbcType=NVARCHAR},
      </if>  
       <if test="taketype != null" >
        #{taketype,jdbcType=SMALLINT},
      </if>    
  
      <if test="productname != null" >
        #{productname,jdbcType=NVARCHAR},
      </if>
      		<if test="tipamount != null">
				#{tipamount,jdbcType=DECIMAL},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.edaisong.entity.Order">
		update [order]
		<set>
			<if test="orderno != null">
				OrderNo = #{orderno,jdbcType=NVARCHAR},
			</if>
			<if test="pickupaddress != null">
				PickUpAddress = #{pickupaddress,jdbcType=NVARCHAR},
			</if>
			<if test="pickuplongitude != null">
				PickUpLongitude = #{pickuplongitude,jdbcType=DOUBLE},
			</if>
			<if test="pickuplatitude != null">
				PickUpLatitude = #{pickuplatitude,jdbcType=DOUBLE},
			</if>
			<if test="pubdate != null">
				PubDate = #{pubdate,jdbcType=TIMESTAMP},
			</if>
			<if test="recevicename != null">
				ReceviceName = #{recevicename,jdbcType=NVARCHAR},
			</if>
			<if test="recevicephoneno != null">
				RecevicePhoneNo = #{recevicephoneno,jdbcType=NVARCHAR},
			</if>
			<if test="receviceaddress != null">
				ReceviceAddress = #{receviceaddress,jdbcType=NVARCHAR},
			</if>
			<if test="actualdonedate != null">
				ActualDoneDate = #{actualdonedate,jdbcType=TIMESTAMP},
			</if>
			<if test="ispay != null">
				IsPay = #{ispay,jdbcType=BIT},
			</if>
			<if test="amount != null">
				Amount = #{amount,jdbcType=NUMERIC},
			</if>
				<if test="tipamount != null">
				tipamount = #{tipamount,jdbcType=DOUBLE},
			</if>
			<if test="ordercommission != null">
				OrderCommission = #{ordercommission,jdbcType=NUMERIC},
			</if>
			<if test="distribsubsidy != null">
				DistribSubsidy = #{distribsubsidy,jdbcType=NUMERIC},
			</if>
			<if test="websitesubsidy != null">
				WebsiteSubsidy = #{websitesubsidy,jdbcType=NUMERIC},
			</if>
			<if test="remark != null">
				Remark = #{remark,jdbcType=NVARCHAR},
			</if>
			<if test="status != null">
				Status = #{status,jdbcType=TINYINT},
			</if>
			<if test="clienterid != null">
				clienterId = #{clienterid,jdbcType=INTEGER},
			</if>
			<if test="businessid != null">
				businessId = #{businessid,jdbcType=INTEGER},
			</if>
			<if test="recevicecity != null">
				ReceviceCity = #{recevicecity,jdbcType=NVARCHAR},
			</if>
			<if test="recevicelongitude != null">
				ReceviceLongitude = #{recevicelongitude,jdbcType=DOUBLE},
			</if>
			<if test="recevicelatitude != null">
				ReceviceLatitude = #{recevicelatitude,jdbcType=DOUBLE},
			</if>
			<if test="orderfrom != null">
				OrderFrom = #{orderfrom,jdbcType=INTEGER},
			</if>
			<if test="originalorderid != null">
				OriginalOrderId = #{originalorderid,jdbcType=BIGINT},
			</if>
			<if test="originalorderno != null">
				OriginalOrderNo = #{originalorderno,jdbcType=NVARCHAR},
			</if>
			<if test="quantity != null">
				Quantity = #{quantity,jdbcType=INTEGER},
			</if>
			<if test="weight != null">
				Weight = #{weight,jdbcType=NUMERIC},
			</if>
			<if test="receiveprovince != null">
				ReceiveProvince = #{receiveprovince,jdbcType=NVARCHAR},
			</if>
			<if test="receivearea != null">
				ReceiveArea = #{receivearea,jdbcType=NVARCHAR},
			</if>
			<if test="receiveprovincecode != null">
				ReceiveProvinceCode = #{receiveprovincecode,jdbcType=NVARCHAR},
			</if>
			<if test="receivecitycode != null">
				ReceiveCityCode = #{receivecitycode,jdbcType=NVARCHAR},
			</if>
			<if test="receiveareacode != null">
				ReceiveAreaCode = #{receiveareacode,jdbcType=NVARCHAR},
			</if>
			<if test="ordertype != null">
				OrderType = #{ordertype,jdbcType=INTEGER},
			</if>
			<if test="km != null">
				KM = #{km,jdbcType=DOUBLE},
			</if>
			<if test="guojuqty != null">
				GuoJuQty = #{guojuqty,jdbcType=INTEGER},
			</if>
			<if test="lujuqty != null">
				LuJuQty = #{lujuqty,jdbcType=INTEGER},
			</if>
			<if test="songcandate != null">
				SongCanDate = #{songcandate,jdbcType=TIMESTAMP},
			</if>
			<if test="ordercount != null">
				OrderCount = #{ordercount,jdbcType=INTEGER},
			</if>
			<if test="commissionrate != null">
				CommissionRate = #{commissionrate,jdbcType=NUMERIC},
			</if>
			<if test="payment != null">
				Payment = #{payment,jdbcType=INTEGER},
			</if>
			<if test="commissionformulamode != null">
				CommissionFormulaMode = #{commissionformulamode,jdbcType=INTEGER},
			</if>
			<if test="adjustment != null">
				Adjustment = #{adjustment,jdbcType=DECIMAL},
			</if>
			<if test="businesscommission != null">
				BusinessCommission = #{businesscommission,jdbcType=DECIMAL},
			</if>
			<if test="settlemoney != null">
				SettleMoney = #{settlemoney,jdbcType=NUMERIC},
			</if>
			<if test="dealcount != null">
				DealCount = #{dealcount,jdbcType=INTEGER},
			</if>
			<if test="pickupcode != null">
				PickupCode = #{pickupcode,jdbcType=VARCHAR},
			</if>
			<if test="othercancelreason != null">
				OtherCancelReason = #{othercancelreason,jdbcType=NVARCHAR},
			</if>
			<if test="commissiontype != null">
				CommissionType = #{commissiontype,jdbcType=INTEGER},
			</if>
			<if test="commissionfixvalue != null">
				CommissionFixValue = #{commissionfixvalue,jdbcType=DECIMAL},
			</if>
			<if test="businessgroupid != null">
				BusinessGroupId = #{businessgroupid,jdbcType=INTEGER},
			</if>
			<if test="timespan != null">
				TimeSpan = #{timespan,jdbcType=NVARCHAR},
			</if>
			<if test="invoice != null">
				Invoice = #{invoice,jdbcType=NVARCHAR},
			</if>
			<if test="businessreceivable != null">
				BusinessReceivable = #{businessreceivable,jdbcType=DECIMAL},
			</if>
			<if test="mealssettlemode != null">
				MealsSettleMode = #{mealssettlemode,jdbcType=INTEGER},
			</if>
			<if test="finishdatelength != null">
				FinishDateLength = #{finishdatelength,jdbcType=INTEGER},
			</if>
			<if test="finishall != null">
				FinishAll = #{finishall,jdbcType=INTEGER},
			</if>
			<if test="realordercommission != null">
				RealOrderCommission = #{realordercommission,jdbcType=NUMERIC},
			</if>
			<if test="groupbusinessid != null">
				groupbusinessid = #{groupbusinessid,jdbcType=NUMERIC},
			</if>
			<if test="basecommission != null">
				basecommission = #{basecommission,jdbcType=NUMERIC},
			</if>
			<if test="isreceivecode != null">
				isreceivecode = #{isreceivecode,jdbcType=INTEGER},
			</if>
		</set>
		where Id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKeySelectiveAndStatus" parameterType="com.edaisong.entity.Order">
		update [order]
		<set>
			<if test="orderno != null">
				OrderNo = #{orderno,jdbcType=NVARCHAR},
			</if>
			<if test="pickupaddress != null">
				PickUpAddress = #{pickupaddress,jdbcType=NVARCHAR},
			</if>
			<if test="pickuplongitude != null">
				PickUpLongitude = #{pickuplongitude,jdbcType=DOUBLE},
			</if>
			<if test="pickuplatitude != null">
				PickUpLatitude = #{pickuplatitude,jdbcType=DOUBLE},
			</if>
			<if test="pubdate != null">
				PubDate = #{pubdate,jdbcType=TIMESTAMP},
			</if>
			<if test="recevicename != null">
				ReceviceName = #{recevicename,jdbcType=NVARCHAR},
			</if>
			<if test="recevicephoneno != null">
				RecevicePhoneNo = #{recevicephoneno,jdbcType=NVARCHAR},
			</if>
			<if test="receviceaddress != null">
				ReceviceAddress = #{receviceaddress,jdbcType=NVARCHAR},
			</if>
			<if test="actualdonedate != null">
				ActualDoneDate = #{actualdonedate,jdbcType=TIMESTAMP},
			</if>
			<if test="ispay != null">
				IsPay = #{ispay,jdbcType=BIT},
			</if>
			<if test="amount != null">
				Amount = #{amount,jdbcType=NUMERIC},
			</if>
				<if test="tipamount != null">
				tipamount = #{tipamount,jdbcType=DOUBLE},
			</if>
			<if test="ordercommission != null">
				OrderCommission = #{ordercommission,jdbcType=NUMERIC},
			</if>
			<if test="distribsubsidy != null">
				DistribSubsidy = #{distribsubsidy,jdbcType=NUMERIC},
			</if>
			<if test="websitesubsidy != null">
				WebsiteSubsidy = #{websitesubsidy,jdbcType=NUMERIC},
			</if>
			<if test="remark != null">
				Remark = #{remark,jdbcType=NVARCHAR},
			</if>
			<if test="status != null">
				Status = #{status,jdbcType=TINYINT},
			</if>
			<if test="clienterid != null">
				clienterId = #{clienterid,jdbcType=INTEGER},
			</if>
			<if test="businessid != null">
				businessId = #{businessid,jdbcType=INTEGER},
			</if>
			<if test="recevicecity != null">
				ReceviceCity = #{recevicecity,jdbcType=NVARCHAR},
			</if>
			<if test="recevicelongitude != null">
				ReceviceLongitude = #{recevicelongitude,jdbcType=DOUBLE},
			</if>
			<if test="recevicelatitude != null">
				ReceviceLatitude = #{recevicelatitude,jdbcType=DOUBLE},
			</if>
			<if test="orderfrom != null">
				OrderFrom = #{orderfrom,jdbcType=INTEGER},
			</if>
			<if test="originalorderid != null">
				OriginalOrderId = #{originalorderid,jdbcType=BIGINT},
			</if>
			<if test="originalorderno != null">
				OriginalOrderNo = #{originalorderno,jdbcType=NVARCHAR},
			</if>
			<if test="quantity != null">
				Quantity = #{quantity,jdbcType=INTEGER},
			</if>
			<if test="weight != null">
				Weight = #{weight,jdbcType=NUMERIC},
			</if>
			<if test="receiveprovince != null">
				ReceiveProvince = #{receiveprovince,jdbcType=NVARCHAR},
			</if>
			<if test="receivearea != null">
				ReceiveArea = #{receivearea,jdbcType=NVARCHAR},
			</if>
			<if test="receiveprovincecode != null">
				ReceiveProvinceCode = #{receiveprovincecode,jdbcType=NVARCHAR},
			</if>
			<if test="receivecitycode != null">
				ReceiveCityCode = #{receivecitycode,jdbcType=NVARCHAR},
			</if>
			<if test="receiveareacode != null">
				ReceiveAreaCode = #{receiveareacode,jdbcType=NVARCHAR},
			</if>
			<if test="ordertype != null">
				OrderType = #{ordertype,jdbcType=INTEGER},
			</if>
			<if test="km != null">
				KM = #{km,jdbcType=DOUBLE},
			</if>
			<if test="guojuqty != null">
				GuoJuQty = #{guojuqty,jdbcType=INTEGER},
			</if>
			<if test="lujuqty != null">
				LuJuQty = #{lujuqty,jdbcType=INTEGER},
			</if>
			<if test="songcandate != null">
				SongCanDate = #{songcandate,jdbcType=TIMESTAMP},
			</if>
			<if test="ordercount != null">
				OrderCount = #{ordercount,jdbcType=INTEGER},
			</if>
			<if test="commissionrate != null">
				CommissionRate = #{commissionrate,jdbcType=NUMERIC},
			</if>
			<if test="payment != null">
				Payment = #{payment,jdbcType=INTEGER},
			</if>
			<if test="commissionformulamode != null">
				CommissionFormulaMode = #{commissionformulamode,jdbcType=INTEGER},
			</if>
			<if test="adjustment != null">
				Adjustment = #{adjustment,jdbcType=DECIMAL},
			</if>
			<if test="businesscommission != null">
				BusinessCommission = #{businesscommission,jdbcType=DECIMAL},
			</if>
			<if test="settlemoney != null">
				SettleMoney = #{settlemoney,jdbcType=NUMERIC},
			</if>
			<if test="dealcount != null">
				DealCount = #{dealcount,jdbcType=INTEGER},
			</if>
			<if test="pickupcode != null">
				PickupCode = #{pickupcode,jdbcType=VARCHAR},
			</if>
			<if test="othercancelreason != null">
				OtherCancelReason = #{othercancelreason,jdbcType=NVARCHAR},
			</if>
			<if test="commissiontype != null">
				CommissionType = #{commissiontype,jdbcType=INTEGER},
			</if>
			<if test="commissionfixvalue != null">
				CommissionFixValue = #{commissionfixvalue,jdbcType=DECIMAL},
			</if>
			<if test="businessgroupid != null">
				BusinessGroupId = #{businessgroupid,jdbcType=INTEGER},
			</if>
			<if test="timespan != null">
				TimeSpan = #{timespan,jdbcType=NVARCHAR},
			</if>
			<if test="invoice != null">
				Invoice = #{invoice,jdbcType=NVARCHAR},
			</if>
			<if test="businessreceivable != null">
				BusinessReceivable = #{businessreceivable,jdbcType=DECIMAL},
			</if>
			<if test="mealssettlemode != null">
				MealsSettleMode = #{mealssettlemode,jdbcType=INTEGER},
			</if>
			<if test="finishdatelength != null">
				FinishDateLength = #{finishdatelength,jdbcType=INTEGER},
			</if>
			<if test="finishall != null">
				FinishAll = #{finishall,jdbcType=INTEGER},
			</if>
			<if test="realordercommission != null">
				RealOrderCommission = #{realordercommission,jdbcType=NUMERIC},
			</if>
			<if test="groupbusinessid != null">
				groupbusinessid = #{groupbusinessid,jdbcType=NUMERIC},
			</if>
			<if test="basecommission != null">
				basecommission = #{basecommission,jdbcType=NUMERIC},
			</if>
			<if test="isreceivecode != null">
				isreceivecode = #{isreceivecode,jdbcType=INTEGER},
			</if>
		</set>
		where Id = #{id,jdbcType=INTEGER} and Status=50
	</update>


	<!-- 后台订单列表页面 查询列集合 add by caoheyang 20150728 -->
	<sql id="GetOrdersColums">
		o.[Id] ,o.[OrderNo] , o.[PickUpAddress] ,
		o.[PubDate] ,
		o.[ReceviceName]
		,o.[RecevicePhoneNo] ,o.[ReceviceAddress] ,
		o.[ActualDoneDate] ,o.[IsPay] , o.[Amount] , o.[OrderCommission] ,
		o.[RealOrderCommission] , o.[DistribSubsidy] , o.[WebsiteSubsidy]
		,o.[Remark] ,
		o.[Status] , o.[clienterId] , o.[businessId] , o.[ReceviceCity] ,
		o.[ReceviceLongitude] , o.[ReceviceLatitude] , o.[OrderFrom] ,
		o.[OriginalOrderId] ,o.[OriginalOrderNo] , o.[Quantity] ,o.[Weight] ,
		o.[ReceiveProvince] , o.[ReceiveArea] , o.[ReceiveProvinceCode]
		,o.[ReceiveCityCode] ,o.[ReceiveAreaCode] ,o.SettleMoney,
		o.[SongCanDate] ,
		 o.[OrderCount] ,o.[CommissionRate] ,
		 c.TrueName ClienterName ,
		c.PhoneNo ClienterPhoneNo , b.Name BusinessName ,b.PhoneNo BusinessPhoneNo ,
		b.Address BusinessAddress ,
		 isnull(g.GroupName,'''') as GroupName,
		 isnull(g.GroupName,'''') as OrderFromName,
		o.[Adjustment] ,
		ISNULL(oo.HadUploadCount, 0) HadUploadCount ,
		CASE ISNULL(oo.GrabLatitude, 0)
		when 0 then -1
		else CASE ISNULL(oo.CompleteLatitude, 0)
		when 0 then -1
		else oo.GrabToCompleteDistance
		end
		end as GrabToCompleteDistance ,
		o.BusinessCommission ,oo.IsNotRealOrder,oo.auditStatus
	</sql>

	<!-- 后台订单列表页面 查询列集来源 add by caoheyang 20150728 -->
	<sql id="GetOrdersFrom">
		[order] o with ( nolock )
		join dbo.OrderOther oo ( nolock ) on o.Id = oo.OrderId
		join business b with ( nolock ) on b.Id = o.businessId
		<if test="tagType == 0 and tagId>0">
			join dbo.TagRelation tagR on b.Id=tagR.UserId and tagR.IsEnable=1 and tagR.UserType=0 and  tagR.TagId=${tagId} 
		</if>
		<if test="tagType == 1 and tagId>0">
			join dbo.TagRelation tagR on c.Id=tagR.UserId and tagR.IsEnable=1 and tagR.UserType=1 and  tagR.TagId=${tagId} 
		</if>
		<if test="authCityStr !=null and authCityStr!=''">
		join [dbo].[Fn_SplitToTable](''${authCityStr}'') AS FS ON FS.Value=b.City
		</if>
		<if test="groupBusinessId >0 ">
			left join GroupBusinessRelation gbr(nolock) on o.BusinessId=gbr.BusinessId 
		</if>
		left join clienter c with ( nolock ) on c.Id = o.clienterId
		left join [group] g with ( nolock ) on g.id = o.OrderFrom
	</sql>
	<!-- 后台订单列表页面 动态查询条件 add by caoheyang 20150728 -->
	<sql id="GetOrdersColumsWhere">
		1=1 and 3>=o.Platform 
		<if test="businessName != null and businessName != ''">
			and b.Name=''${businessName}''
		</if>
		<if test="groupBusinessId >0 ">
			and gbr.GroupId=${groupBusinessId} 
		</if>
		<if test="businessID != null">
			and b.id=${businessID}
		</if>
		<if test="businessPhone != null and businessPhone!='' ">
			and b.PhoneNo=''${businessPhone}''
		</if>
		<if test="orderId != null and orderId!=''">
			and o.OrderNo=''${orderId}''
		</if>
		<if test="originalOrderNo != null and originalOrderNo!=''">
			and o.OriginalOrderNo=''${originalOrderNo}''
		</if>
		<if test="orderStatus != null and orderStatus>-1">
			and o.Status=${orderStatus}
		</if>
		<if test="superManName != null and superManName!=''">
			and c.TrueName=''${superManName}''
		</if>
		<if test="superManPhone != null and superManPhone!='' ">
			and c.PhoneNo=''${superManPhone}''
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and o.PubDate>= ''${orderPubStart} 00:00:00''
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND DATEADD(d, 1, ''${orderPubEnd}'')>o.PubDate
		</if>
		<if test="auditStatus != null and auditStatus>-1">
			and oo.auditStatus= ${auditStatus}
		</if>
		<if test="groupId != null and groupId != -1">
			and o.OrderFrom = ${groupId}
		</if>
		<if test="businessCity != null and businessCity!=''">
			and b.city = ''${businessCity}''
		</if>
		<if test="groupBusinessId != null and groupBusinessId!=-1">
			and o.GroupBusinessId =${groupBusinessId}
		</if>

	</sql>

	<!--后台订单列表页面 add by caoheyang 20150728 -->
	<select id="GetOrders" resultType="com.edaisong.entity.domain.OrderListModel"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' o.Status ASC,o.Id DESC ',
		'
		<include refid="GetOrdersColums" />
		',
		'
		<include refid="GetOrdersFrom" />
		',
		'
		<include refid="GetOrdersColumsWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>

  <select id="exportOrder" resultType="com.edaisong.entity.domain.ExportOrder"
  		 parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
  	   select 	 o.[OrderNo] ,
                ISNULL(b.Name, '匿名') + ':' + ISNULL(b.PhoneNo, '无') as BusinessInfo ,
                ISNULL(c.TrueName, '匿名') + ':' + ISNULL(c.PhoneNo, '无') as ClienterInfo ,
                CONVERT(VARCHAR(100), o.[PubDate], 120) as PubDate ,
                ISNULL(CONVERT(VARCHAR(100), o.[ActualDoneDate], 120),'') as ActualDoneDate ,
                o.[Amount] ,
                ISNULL(o.[Amount], 0) + ISNULL(o.[OrderCount], 0)
                * ISNULL(o.[DistribSubsidy], 0) as TotalAmount ,
                ISNULL(o.[OrderCommission], 0) as OrderCommission ,
                ISNULL(o.[OrderCount], 0) as OrderCount ,
                ISNULL(o.[DistribSubsidy], 0) as DistribSubsidy ,
                ISNULL(o.[WebsiteSubsidy], 0) as WebsiteSubsidy ,
                ISNULL(o.[Adjustment], 0) as Adjustment ,
                ISNULL(o.[SettleMoney], 0) as SettleMoney
		from [order] o with ( nolock )
		join dbo.OrderOther oo ( nolock ) on o.Id = oo.OrderId
		join business b with ( nolock ) on b.Id = o.businessId
		left join clienter c with ( nolock ) on c.Id = o.clienterId
		left join [group] g with ( nolock ) on g.id = o.OrderFrom

		where 1=1    
 		<if test="businessName != null  and businessName !=''">
			and b.Name=#{businessName}
		</if>
		<if test="businessPhone != null and businessPhone!=''">
			and b.PhoneNo=#{businessPhone}
		</if>
		<if test="orderStatus != null and orderStatus>-1">
			and o.Status=#{orderStatus}
		</if>
		<if test="superManName != null and superManName!=''">
			and c.TrueName=#{superManName}
		</if>
		<if test="superManPhone != null and superManPhone!='' ">
			and c.PhoneNo=#{superManPhone}
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and o.PubDate>= '${orderPubStart} 00:00:00'
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND DATEADD(d, 1, '${orderPubEnd}')>o.PubDate
		</if>
		<if test="groupId != null and groupId != -1">
			and o.OrderFrom = #{groupId}
		</if>
		<if test="businessCity != null and businessCity!='' and businessCity!='-1'">
			and b.City= #{businessCity}
		</if>
	<!-- 	<if test="authorityCityNameList != null">
			and b.city in
			<foreach item="item" index="index" collection="authorityCityNameList"
				open="(''" separator="'',''" close="'')">
				#{item}
			</foreach>
		</if> -->
  </select>
  
	<!-- 根据订单号/订单id查订单信息 Caoheyang 20150827 -->
	<select id="getOrderByNoId" resultType="com.edaisong.entity.domain.OrderListModel"
		parameterType="java.util.Map">
		SELECT top 1 o.[Id]
		,o.[OrderNo]
		,o.[Platform]
		,o.[PickUpAddress]
		,o.PubDate
		,o.[ReceviceName]
		,o.[RecevicePhoneNo]
		,o.[ReceviceAddress]
		,o.[ActualDoneDate]
		,o.[IsPay]
		,o.[Amount]
		,o.[OrderCommission]
		,o.[DistribSubsidy]
		,o.[WebsiteSubsidy]
		,o.[Remark]
		,o.[Status]
		,o.[clienterId]
		,o.[businessId]
		,o.[ReceviceCity]
		,o.[ReceviceLongitude]
		,o.[ReceviceLatitude]
		,o.[OrderFrom]
		,o.[OriginalOrderId]
		,o.[OriginalOrderNo]
		,o.[Quantity]
		,o.[Weight]
		,o.[ReceiveProvince]
		,o.[ReceiveArea]
		,o.[ReceiveProvinceCode]
		,o.[ReceiveCityCode]
		,o.[ReceiveAreaCode]
		,o.[OrderType]
		,o.[KM]
		,o.[GuoJuQty]
		,o.[LuJuQty]
		,o.[SongCanDate]
		,o.[OrderCount]
		,o.[CommissionRate]
		,b.[City] BusinessCity
		,b.Name BusinessName
		,b.PhoneNo BusinessPhoneNo
		,b.Address BusinessAddress
		,c.PhoneNo ClienterPhoneNo
		,c.TrueName ClienterTrueName
		,c.TrueName ClienterName
		,c.AccountBalance AccountBalance
		,b.GroupId
		,isnull(g.GroupName,'') as GroupName
		,isnull(g.GroupName,'') as OrderFromName
		,o.OriginalOrderNo
		,oo.NeedUploadCount
		,oo.HadUploadCount
		,oo.ReceiptPic
		,oo.DeductCommissionReason
		,o.OtherCancelReason
		,o.OriginalOrderNo
		,o.IsEnable
		,o.FinishAll
		,ISNULL(oo.DeductCommissionType,0) DeductCommissionType
		,ISNULL(oo.IsJoinWithdraw,0) IsJoinWithdraw
		,ISNULL(oo.IsOrderChecked,1) IsOrderChecked
		,ISNULL(o.SettleMoney,0)  SettleMoney
		,o.MealsSettleMode
		FROM [order] o WITH ( NOLOCK )
		JOIN OrderOther oo WITH (NOLOCK) ON oo.OrderId=o.Id
		LEFT JOIN business b WITH ( NOLOCK ) ON b.Id = o.businessId
		LEFT JOIN clienter c WITH (NOLOCK) ON o.clienterId=c.Id
		LEFT JOIN [group] g WITH ( NOLOCK ) ON g.Id = o.orderfrom
		WHERE 1=1
		<if test="orderNo != null and orderNo != '' ">
			and o.OrderNo = #{orderNo,jdbcType=NVARCHAR}
		</if>
		<if test="orderId != 0  ">
			and o.id = #{orderId,jdbcType=INTEGER}
		</if>
	</select>


	<!--后台订单列表百度地图打点基础数据 add by caoheyang 20150728 -->
	<select id="getOrderMapDetail" resultType="com.edaisong.entity.domain.OrderMapDetail"
		parameterType="java.lang.Integer">
		select ord.OrderId,
		CASE WHEN ISNULL(PubLongitude, 0) = 0 THEN c.Longitude
		ELSE PubLongitude
		END AS PubLongitude ,
		CASE WHEN ISNULL(PubLatitude, 0) = 0 THEN c.Latitude
		ELSE PubLatitude
		END AS PubLatitude ,
		CONVERT(varchar(100), ab.PubDate, 20)   as PubDate,
		ISNULL(GrabLongitude, 0) AS GrabLongitude,
		ISNULL(GrabLatitude, 0) AS GrabLatitude,
		CONVERT(varchar(100), GrabTime, 20)   as GrabTime,
		ISNULL(TakeLongitude, 0) AS TakeLongitude ,
		ISNULL(TakeLatitude, 0) AS TakeLatitude,
		CONVERT(varchar(100), TakeTime, 20)   as TakeTime,
		ISNULL(CompleteLongitude, 0) AS CompleteLongitude,
		ISNULL(CompleteLatitude, 0) AS CompleteLatitude,
		CONVERT(varchar(100), ab.ActualDoneDate, 20)   as ActualDoneDate,
		CASE ISNULL(ord.GrabLatitude, 0)
		WHEN 0 THEN -1
		ELSE CASE ISNULL(ord.CompleteLatitude, 0)
		WHEN 0 THEN -1
		ELSE ord.GrabToCompleteDistance
		END
		END AS GrabToCompleteDistance,
		ISNULL(ord.IsPubDateTimely, 0) as IsPubDateTimely ,
        ISNULL(ord.IsGrabTimely, 0) as IsGrabTimely ,
        ISNULL(ord.IsTakeTimely, 0) as IsTakeTimely,
        ISNULL(ord.IsCompleteTimely, 0) as IsCompleteTimely ,
         ISNULL(ab.clienterId, 0)  as  ClienterId
		FROM [order] (NOLOCK) ab
		JOIN OrderOther (NOLOCK) ord ON ord.OrderId = ab.Id
		JOIN business (NOLOCK) c ON c.id = ab.businessId
		WHERE ab.Id =#{orderId,jdbcType=INTEGER} 
	</select>

	<!--商家后台 订单详情页面基础数据 add by caoheyang 20150804 -->
	<select id="getOrderDetailBusiness" resultType="com.edaisong.entity.domain.OrderDetailBusiness"
		parameterType="com.edaisong.entity.req.OrderDetailBusinessReq">
		select top 1
		a.Id,a.OrderNo,a.Status,a.OrderFrom,a.OriginalOrderNo,a.Remark,a.PubDate,
		b.GrabTime,b.TakeTime,b.CancelTime,a.ActualDoneDate,a.RecevicePhoneNo,a.ReceviceAddress,c.TrueName,c.PhoneNo,
		a.Amount,a.OrderCommission,a.IsPay,a.SettleMoney
		,isnull(d.GroupName,'') as GroupName
		,isnull(d.GroupName,'') as OrderFromName 
		from dbo.[order] ( nolock ) a
		join dbo.OrderOther ( nolock ) b on a.Id=b.OrderId
		LEFT join dbo.clienter ( nolock ) c on a.clienterId=c.Id
		left join dbo.[group] d on a.OrderFrom=d.Id
		where a.OrderNo=#{orderNo,jdbcType=NVARCHAR} 
		<if test="businessId !=0 ">
			and a.BusinessId= #{businessId,jdbcType=INTEGER}
		</if>
	</select>
	<!-- 商户取消订单功能 add by caoheyang 20150804 -->
	<update id="cancelOrderBusiness" parameterType="com.edaisong.entity.Order">
		UPDATE dbo.[order]
		SET [Status] =3,OtherCancelReason= #{othercancelreason,jdbcType=NVARCHAR}
		output
		Inserted.Id,#{amount},GETDATE(),'商家',#{othercancelreason,jdbcType=NVARCHAR},Inserted.businessId,Inserted.[Status],0
		into
		dbo.OrderSubsidiesLog(OrderId,Price,InsertTime,OptName,Remark,OptId,OrderStatus,[Platform])
		WHERE OrderNo= #{orderno,jdbcType=NVARCHAR} and Status=
		#{status,jdbcType=INTEGER}
	</update>



	<!-- 根据商家Id获得商家订单概述 add by pengyi 20150818 -->
	<select id="getBusinessOrderSummary" resultMap="businessOrderSummaryResultMap"
		parameterType="java.lang.Integer">
		WITH o AS (
		SELECT sum(CASE WHEN [Status]=1 THEN 1 ELSE 0 end) AS 'finish',
		sum(CASE WHEN [Status]=2 THEN 1 ELSE 0 end) AS 'received', --待抢单
		sum(CASE WHEN [Status]=3 THEN 1 ELSE 0 end) AS 'cancel', --已完成
		sum(CASE WHEN [Status]=4 THEN 1 ELSE 0 end) AS 'pickUp', --已取消
		sum(CASE WHEN [Status]=0 THEN 1 ELSE 0 end) AS 'unReceive'--配送中
		FROM dbo.[order] (NOLOCK) WHERE businessId= #{id,jdbcType=INTEGER}) --待取货
		SELECT
		b.Name,b.Address,b.City,b.BalancePrice,b.LastLoginTime,o.finish,o.received,o.cancel,o.pickUp,o.unReceive
		FROM o JOIN dbo.business (NOLOCK) b ON b.id = #{id,jdbcType=INTEGER};
	</select>

	<!-- 根据商家Id获得商家发布订单时间统计 add by pengyi 20150819 -->
	<select id="getBusiPubOrderTimeStatistics" resultMap="busiPubOrderTimeStatisticsResultMap"
		parameterType="java.util.Map">
		SELECT SUM(OrderCount) as pubCount, DATENAME(HOUR,o.PubDate) AS hour
		FROM dbo.[order] (NOLOCK) o
		WHERE businessId=#{businessId,jdbcType=INTEGER} AND
		PubDate>=#{startTime,jdbcType=TIMESTAMP} AND <![CDATA[PubDate<=#{endTime,jdbcType=TIMESTAMP} ]]>
		GROUP BY DATENAME(HOUR,o.PubDate) ORDER BY hour;
	</select>
	<!--商家中心订单列表页面右上角自定义查询 ） add by zhaohailong 20150821 -->
	<sql id="customerGetOrdersWhere">
		1=1
		<if test="search != null and search!='' and businessID>0">
			and b.id=${businessID} and (o.OrderNo=''${search}''
			or c.TrueName=''${search}''
			or c.PhoneNo=''${search}'')
		</if>
	</sql>

	<!--商家中心订单列表页面右上角自定义查询 ） add by zhaohailong 20150821 -->
	<select id="customerGetOrders" resultType="com.edaisong.entity.domain.OrderListModel"
		parameterType="com.edaisong.entity.req.PagedCustomerSearchReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' o.PubDate desc ',
		'
		<include refid="GetOrdersColums" />
		',
		'
		<include refid="GetOrdersFrom" />
		',
		'
		<include refid="customerGetOrdersWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
		<!-- 更新订单真实佣金 add by caoheyang 20150831 -->
	<update id="updateOrderRealCommission" parameterType="com.edaisong.entity.req.OrderOtherSearch">
		update [Order] set RealOrderCommission=#{realOrderCommission,jdbcType=NVARCHAR}  where id=#{orderId,jdbcType=INTEGER}
	</update>
	<!-- B端任务统计接口 统计当月服务骑士信息 add by caoheyang 20150910 -->
	<select id="getOrderStatisticsServiceClienterB" parameterType="com.edaisong.entity.req.OrderStatisticsBReq"   resultType="com.edaisong.entity.domain.ServiceClienter">
declare @sdate DATETIME
set @sdate = '${monthInfo}-01'
declare @startDate date ;
declare @endDate date ;
set  @startDate  = dateadd(dd,-day(@sdate)+1,@sdate);  
set  @endDate=   dateadd(dd,1-day(@sdate),dateadd(m,1,@sdate));
select  ISNULL(b.Id,0) as ClienterId ,
        ISNULL(b.PhoneNo,'未知') as ClienterPhone ,
        ISNULL(b.TrueName,'未知') as ClienterName ,
        SUM(a.OrderCount) as OrderCount ,
        CONVERT(VARCHAR(100), a.PubDate, 23) as PubDate,
        ISNULL(MIN (b.HeadPhoto),'') as ClienterPhoto
from    dbo.[order] (nolock)a
        LEFT join dbo.clienter (nolock) b on a.clienterId = b.Id
where   a.Status = 1   and businessId=#{businessId}  and a.[Platform] IN(${platform})
and a.PubDate>=@startDate and a.PubDate <![CDATA[ <]]> @endDate
group by b.Id ,
        b.PhoneNo ,
        b.TrueName ,
        CONVERT(VARCHAR(100), a.PubDate, 23) ,
        DATEPART(day, a.PubDate)
order by PubDate desc 
	</select>
	
		<!-- B端任务统计接口  天数据列表  add by caoheyang 20150910 -->
	<select id="getOrderStatisticsDaySatistics" parameterType="com.edaisong.entity.req.OrderStatisticsBReq"   resultType="com.edaisong.entity.domain.DaySatisticsB">
	declare @sdate DATETIME
set @sdate = '${monthInfo}-01'
declare @startDate date ;
declare @endDate date ;
set  @startDate  = dateadd(dd,-day(@sdate)+1,@sdate) ; 
set  @endDate=   dateadd(dd,1-day(@sdate),dateadd(m,1,@sdate));
select  a.MonthDate ,
        ISNULL(b.OrderCount, 0) as OrderCount ,
        ISNULL(b.ServiceClienterCount, 0) as ServiceClienterCount ,
        a.DateInfo
from    ( select    CONVERT(VARCHAR(100), DATEADD(dd, number, @sdate), 23) as MonthDate ,
                    CONVERT(VARCHAR(4), DATEPART(day,
                                                 DATEADD(dd, number, @sdate)))
                    + '日' as DateInfo
          from      master..spt_values
          where     type = 'P'
                    and DATEADD(dd, number, @sdate) <![CDATA[ <]]> DATEADD(mm, 1, @sdate)
        ) a
        left join ( select  SUM(OrderCount) as OrderCount ,
                            COUNT(distinct clienterId) as ServiceClienterCount ,
                            CONVERT(VARCHAR(100), PubDate, 23) as OrderDate
                    from    dbo.[order] (nolock)
                    where   Status = 1 and businessId=#{businessId} and [Platform] IN(${platform}) 
                    and PubDate>=@startDate and PubDate  <![CDATA[ <]]>  @endDate
                    group by CONVERT(VARCHAR(100), PubDate, 23)
                  ) as b on a.MonthDate = b.OrderDate
where a.MonthDate <![CDATA[ <=]]>GETDATE()  
ORDER BY MonthDate DESC 
	</select>
			<!-- B端任务统计接口  天数据列表  add by caoheyang 20150910 -->
	<select id="getOrderStatistics" parameterType="com.edaisong.entity.req.OrderStatisticsBReq"   resultType="com.edaisong.entity.resp.OrderStatisticsBResp">
	declare @sdate DATETIME
set @sdate = '${monthInfo}-01'
declare @startDate date ;
declare @endDate date ;
set  @startDate  = dateadd(dd,-day(@sdate)+1,@sdate) ; 
set  @endDate=   dateadd(dd,1-day(@sdate),dateadd(m,1,@sdate));
  
select  isnull(SUM(ISNULL(ordercount,0)),0) as OrderCount ,
        COUNT(distinct ISNULL(clienterId,0)) as ServiceClienterCount ,
        ISNULL(SUM(Amount),0)  as TotalAmount
from    dbo.[order] (nolock) 
where   Status = 1
        and PubDate >= @startDate and PubDate <![CDATA[ <]]> @endDate
        and businessId=#{businessId} and [Platform] IN( ${platform} ) 
	</select>

    <!-- C端任务统计接口  天数据列表  wangxudan 20150910 -->
	<select id="getOrderStatisticsDaySatisticsC" parameterType="com.edaisong.entity.req.OrderStatisticsCReq"   resultType="com.edaisong.entity.domain.DaySatisticsC">
declare @sdate DATETIME
set @sdate = '${monthInfo}-01'
declare @startDate date ;
declare @endDate date ;
set  @startDate  = dateadd(dd,-day(@sdate)+1,@sdate) ; 
set  @endDate=   dateadd(dd,1-day(@sdate),dateadd(m,1,@sdate));
SELECT  tbldate.MonthDate,
		tbldate.DateInfo,
		ISNULL(tbl.TotalCount,0) OrderCount,
		ISNULL(tbl.TotalCommission,0) OrderCommission
FROM(
	  SELECT CONVERT(VARCHAR(100), DATEADD(dd, number, @sdate), 23) as MonthDate ,
			 CONVERT(VARCHAR(4), DATEPART(day,DATEADD(dd, number, @sdate)))+ '日' as DateInfo
      FROM master..spt_values
      WHERE type = 'P'
		AND DATEADD(dd, number, @sdate)<![CDATA[ <]]> DATEADD(mm, 1, @sdate)) tbldate
LEFT JOIN (  SELECT 
                ISNULL(SUM(CASE 
						WHEN o. FinishAll = 0 THEN 0 
						ELSE
						 CASE 
						  WHEN oo.AuditStatus=2 AND o.OrderCommission>o.SettleMoney THEN o.SettleMoney 
						  ELSE o.OrderCommission END  
						 END),0) TotalCommission,
				CONVERT (VARCHAR(10),PubDate,120) PubDate,
				SUM(OrderCount) TotalCount
		FROM dbo.[order] o WITH(NOLOCK)
		join  OrderOther oo  WITH(NOLOCK) ON o.id=oo.OrderId
		WHERE o.clienterId=#{clienterId} AND o.Status = 1 and o.[Platform] IN( ${platform})  
		GROUP BY  Convert (VARCHAR(10),o.PubDate,120)
		) tbl ON tbl.PubDate=tbldate.MonthDate
WHERE tbldate.MonthDate <![CDATA[ <=]]>GETDATE()
ORDER BY tbldate.MonthDate   DESC
	</select>
    <!-- C端任务统计接口  wangxudan 20150910 -->
	<select id="getOrderStatisticsC" parameterType="com.edaisong.entity.req.OrderStatisticsCReq"   resultType="com.edaisong.entity.resp.OrderStatisticsCResp">
declare @sdate DATETIME
set @sdate = '${monthInfo}-01'
declare @startDate date ;
declare @endDate date ;
set  @startDate  = dateadd(dd,-day(@sdate)+1,@sdate) ; 
set  @endDate=   dateadd(dd,1-day(@sdate),dateadd(m,1,@sdate));
  
select  SUM(ISNULL(o.OrderCount,0)) as TotalOrderCount ,
	        ISNULL(SUM(CASE 
						WHEN o. FinishAll = 0 THEN 0 
						ELSE
						 CASE 
						  WHEN oo.AuditStatus=2 AND o.OrderCommission>o.SettleMoney THEN o.SettleMoney 
						  ELSE o.OrderCommission END  
						 END),0) TotalOrderCommission
from    dbo.[order] o WITH(NOLOCK)
join  OrderOther oo  WITH(NOLOCK) ON o.id=oo.OrderId
where   Status = 1
        and o.PubDate >= @startDate and o.PubDate <![CDATA[ <]]> @endDate
        and o.clienterId=#{clienterId}  
		and o.[Platform] IN( ${platform}) 
	</select>
		<!--  移动端 订单列表  add by caoheyang 20150910-->
	<select id="queryOrder" resultType="com.edaisong.entity.domain.QueryOrder"
		parameterType="com.edaisong.entity.req.QueryOrderReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		'
		<if test="orderBy  ==0 ">
			o.PubDate asc
		</if>
		 <if test="orderBy  ==1 ">
			o.ActualDoneDate desc
		</if>
		',
		'
		<include refid="queryOrderColums" />
		',
		'
		<include refid="queryOrderFrom" />
		',
		'
		<include refid="queryOrderWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>	
	<!--   移动端 订单列表add by caoheyang 20150910 -->
	<sql id="queryOrderColums">
		CONVERT(VARCHAR(16), o.ActualDoneDate, 120) ActualDoneDate ,
        o.Amount ,
        o.OrderCount ,
        o.IsPay ,
        o.OrderNo ,
        o.PickUpAddress ,
        CONVERT(VARCHAR(16), o.PubDate, 120) PubDate ,
        case   isnull(o.ReceviceAddress,'''')  
		when  '''' then ''附近3公里左右，由商户指定''
		else o.ReceviceAddress end as ReceviceAddress,
        o.ReceviceName ,
        o.RecevicePhoneNo ,
        o.ReceviceCity ,
        o.Remark ,
        o.Status ,
        o.ReceviceLongitude ,
        o.ReceviceLatitude ,
        b.Id as BusinessId ,
        b.Name as BusinessName ,
        b.PhoneNo as BusinessPhone ,
        b.PhoneNo2 as BusinessPhone2 , 
        c.TrueName as SuperManName ,
        c.PhoneNo as SuperManPhone ,
        o.OrderFrom ,
        o.id as OrderId ,
        o.MealsSettleMode ,
        b.Longitude ,
        b.Latitude ,
        isnull(o.km,0) km, isnull(o.[weight],0) weight,
        REPLACE(b.City, ''市'', '''') as pickUpCity ,
        ( o.Amount + ISNULL(o.DistribSubsidy, 0) * ISNULL(o.OrderCount, 0) ) as TotalAmount ,
        ISNULL(o.OriginalOrderNo, '''') as OriginalOrderNo ,
        o.OrderCommission ,
        b.GroupId ,o.[Platform],
        CONVERT(VARCHAR(16), oo.GrabTime, 120) GrabTime,
        o.PubName,
        ISNULL(o.Amount,0)+ISNULL(o.TipAmount,0) as AmountAndTip,
        ISNULL(oo.HadUploadCount, 0) HadUploadCount ,isnull(g.GroupName,'''') as OrderFromName
	</sql>
	<!--   移动端 订单列表add by caoheyang 20150910 -->
	<sql id="queryOrderFrom">
		 [order] (nolock) as o
        join dbo.OrderOther oo ( nolock ) on o.Id = oo.OrderId
        join business (nolock) as b on o.businessId = b.Id
        left join clienter (nolock) as c on o.clienterId = c.Id
        left join dbo.[group] (nolock) g on o.OrderFrom = g.Id
                                            and g.IsValid = 1 
	</sql>
	<!--   移动端 订单列表add by caoheyang 20150910 -->
	<sql id="queryOrderWhere">
		1=1 and o.IsEnable=1  and o.[Platform] IN ( ${platform}) 
	   <if test="clienterId != null and  clienterId !=0 ">
			and o.clienterId=${clienterId}
		</if> 
		<if test="businessId != null and  businessId !=0 ">
			and o.businessId=${businessId}
		</if> 
		 <if test="status != null">
			and o.status=${status}
		</if> 
		<if test="dateInfo != null">
			and  CONVERT(VARCHAR(100), PubDate, 23)=''${dateInfo}''
		</if> 
	</sql>
		<!--商家端我的任务 addby caoheyang 20150914 -->
	<select id="queryOrderB" parameterType="com.edaisong.entity.req.QueryOrderReq"   resultType="com.edaisong.entity.resp.QueryOrderBResp">
	     select  ISNULL(SUM(CASE Status
              when 0 then 1
              else 0
            end),0) newCount ,
        ISNULL(SUM(CASE Status
              when 2 then 1
              else 0
            end),0) deliveryCount ,
        ISNULL(SUM(CASE Status
              when 4 then 1
              else 0
            end),0) takingCount
       from    dbo.[order] (nolock)
       where businessId=${businessId} and [Platform] IN( ${platform} )
	</select>
	<!-- 骑士端我的任务 addby caoheyang 20150914 -->
		<select id="queryOrderC" parameterType="com.edaisong.entity.req.QueryOrderReq"   resultType="com.edaisong.entity.resp.QueryOrderCResp">
	   select  
        ISNULL(SUM(CASE Status
              when 2 then 1
              else 0
            end) ,0)deliveryCount ,
            ISNULL(SUM(CASE Status
              when 4 then 1
              else 0
            end),0) takingCount
       from    dbo.[order] (nolock)
       where  clienterId=${clienterId} and [Platform] IN( ${platform} )
	</select>
		<!--   c端查询待取货订单（会计算距离） 订单列表  add by caoheyang 20150910-->
	<select id="queryDeliveryOrderC" resultType="com.edaisong.entity.domain.QueryOrder"
		parameterType="com.edaisong.entity.req.QueryOrderReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' o.PubDate asc ',
		'
		<include refid="queryDeliveryOrderCColums" />
		',
		'
		<include refid="queryDeliveryOrderCFrom" />
		',
		'
		<include refid="queryDeliveryOrderCWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>	
	<!--  c端查询待取货订单（会计算距离） -->
	<sql id="queryDeliveryOrderCColums">
		CONVERT(VARCHAR(16), o.ActualDoneDate, 120) ActualDoneDate ,
        o.Amount ,
        o.OrderCount ,
        o.IsPay ,
        o.OrderNo ,
        case when o.[Platform]= 1 then b.[Address]  when o.[Platform]=3 then o.PickUpAddress else b.[Address] end PickUpAddress,
        CONVERT(VARCHAR(16), o.PubDate, 120) as PubDate ,
        case  isnull(o.ReceviceAddress,'''')  
		when  '''' then ''附近3公里左右，由商户指定''
		else o.ReceviceAddress end as ReceviceAddress,
        o.ReceviceName ,
        o.RecevicePhoneNo ,
        o.ReceviceCity ,
        o.Remark ,
        o.Status ,
        o.ReceviceLongitude ,
        o.ReceviceLatitude ,
        b.Id as BusinessId ,
        b.Name as BusinessName ,
        b.PhoneNo as BusinessPhone ,
        b.PhoneNo2 as BusinessPhone2 , 
        c.TrueName as SuperManName ,
        c.PhoneNo as SuperManPhone ,
        o.OrderFrom ,
        o.id as OrderId ,
        o.MealsSettleMode ,
        b.Longitude ,
        b.Latitude ,
        REPLACE(b.City, ''市'', '''') as pickUpCity ,
        ( o.Amount + ISNULL(o.DistribSubsidy, 0) * ISNULL(o.OrderCount, 0) ) as TotalAmount ,
        ISNULL(o.OriginalOrderNo, '''') as OriginalOrderNo ,
        o.OrderCommission ,
        b.GroupId ,
        o.KM,o.[Weight],o.[platform],
        CONVERT(VARCHAR(16), oo.GrabTime,120) GrabTime,
        o.PubName,
        round(geography::Point(ISNULL(b.Latitude,0),ISNULL(b.Longitude,0),4326).STDistance(geography::Point(${latitude},${longitude},4326)),0)  as distance_OrderBy  ,
        ISNULL(oo.HadUploadCount, 0) HadUploadCount ,isnull(g.GroupName,'''') as OrderFromName
	</sql>
	<!--    c端查询待取货订单（会计算距离） 订单列表add by caoheyang 20150910 -->
	<sql id="queryDeliveryOrderCFrom">
		 [order] (nolock) as o
        join dbo.OrderOther oo ( nolock ) on o.Id = oo.OrderId
        join business (nolock) as b on o.businessId = b.Id
        left join clienter (nolock) as c on o.clienterId = c.Id
        left join dbo.[group] (nolock) g on o.OrderFrom = g.Id
                                            and g.IsValid = 1
	</sql>
	<!--    c端查询待取货订单（会计算距离） 订单列表add by caoheyang 20150910 -->
	<sql id="queryDeliveryOrderCWhere">
		1=1 and o.IsEnable=1 and o.[platform] IN(${platform}) 
	   <if test="clienterId != null and  clienterId !=0 ">
			and o.clienterId=${clienterId}
		</if> 
		<if test="businessId != null and  businessId !=0 ">
			and o.businessId=${businessId}
		</if> 
		 <if test="status != null">
			and o.status=${status}
		</if> 
		<if test="dateInfo != null">
			and  CONVERT(VARCHAR(100), PubDate, 23)=''${dateInfo}''
		</if> 
	</sql>
		<sql id="busTaskList_Where">
		 o.Status!=3 and oo.AuditStatus=0 
	    <if test="startDate != null and  startDate !='' ">
			and o.PubDate>=''${startDate}''
		</if> 
		 <if test="endDate != null and  endDate !='' ">
		 	AND DATEADD(d, 1, ''${endDate}'')>o.PubDate
		</if> 
		 <if test="cityName != null and  cityName  !='' ">
			and b.city=''${cityName}''
		</if> 
		 <if test="selectType == 1 and  selectValue !='' ">
			and b.Name LIKE ''%${selectValue}%''
		</if> 
		<if test="selectType == 2 and  selectValue !='' ">
			and b.PhoneNo = ''${selectValue}''
		</if> 
	</sql>
	<sql id="busTaskListTables">
	
		 dbo.[order] AS o ( NOLOCK )
        INNER JOIN dbo.business AS b ( NOLOCK ) ON b.Id = o.businessId 
        JOIN dbo.OrderOther AS oo(nolock) ON o.id=oo.OrderId
        <if test="authCityStr !=null and authCityStr!=''">
        join [dbo].[Fn_SplitToTable](''${authCityStr}'') AS FS ON FS.Value=b.City
        </if>
	</sql>
	<select id="busTaskList" resultType="com.edaisong.entity.domain.BusTaskList"
		parameterType="com.edaisong.entity.req.PagedBusTaskListReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V2(
		'  COUNT(o.id) desc',
		'
		MIN(b.Name) AS Name ,
        MIN(b.PhoneNo) AS PhoneNo ,
        businessId ,
        COUNT(o.id) AS OrderCount ,
        SUM(o.OrderCount) AS TaskCount 
		',
		'
		<include refid="busTaskListTables" />
		',
		'
		<include refid="busTaskList_Where" />
		',
		' 
		 o.businessId 
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
		<!--商家端新模式下的处理中的今日订单 addby zhaohailong 20151124 -->
	<select id="queryTodayOrderDetailing" parameterType="java.lang.Long"   resultType="com.edaisong.entity.domain.RegionOrderDetail">
               SELECT   b.OrderRegionOneId ,
                		b.OrderRegionOneName AS OneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName AS TwoName ,
                        1 as Status ,
                        COUNT(0) AS Num
               FROM     dbo.[order] a ( NOLOCK )
                		JOIN OrderGrabChild m ( NOLOCK ) ON a.id = m.OrderId
                        join OrderGrab b (nolock) ON b.Id = m.GrabOrderId
               WHERE    a.businessId=#{businessId}
                        AND CONVERT(VARCHAR(10), a.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                        and b.status =1
               GROUP BY b.OrderRegionOneId ,
                		b.OrderRegionOneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName
              union all
                             SELECT   b.OrderRegionOneId ,
                		b.OrderRegionOneName AS OneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName AS TwoName ,
                        2 as Status ,
                        COUNT(0) AS Num
               FROM     dbo.[order] a ( NOLOCK )
                		JOIN OrderGrabChild m ( NOLOCK ) ON a.id = m.OrderId
                        join OrderGrab b (nolock) ON b.Id = m.GrabOrderId
               WHERE    a.businessId=#{businessId}
                        AND CONVERT(VARCHAR(10), a.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                        and b.status =2
               GROUP BY b.OrderRegionOneId ,
                		b.OrderRegionOneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName
               union all
                             SELECT   b.OrderRegionOneId ,
                		b.OrderRegionOneName AS OneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName AS TwoName ,
                        4 as Status ,
                        COUNT(0) AS Num
               FROM     dbo.[order] a ( NOLOCK )
                		JOIN OrderGrabChild m ( NOLOCK ) ON a.id = m.OrderId
                        join OrderGrab b (nolock) ON b.Id = m.GrabOrderId
               WHERE    a.businessId=#{businessId}
                        AND CONVERT(VARCHAR(10), a.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                        and b.status =4
               GROUP BY b.OrderRegionOneId ,
                		b.OrderRegionOneName ,
                        b.OrderRegionTwoId ,
                        b.OrderRegionTwoName
	</select>
		<!--商家端新模式下的待接单的今日订单 addby zhaohailong 20151124 -->
	<select id="queryTodayOrderDetailWait" parameterType="java.lang.Long"   resultType="com.edaisong.entity.domain.RegionOrderDetail">

				--待接单
               SELECT  m1.OrderRegionOneId ,
                		'' AS OneName ,
                        m1.OrderRegionTwoId ,
                        '' AS TwoName ,
                        0 as Status,
                        COUNT(0) AS Num
                    FROM    [order] b1 ( NOLOCK )
                            JOIN orderchild m1 ( NOLOCK ) ON b1.id = m1.orderid
                    WHERE   b1.businessId = #{businessId}
                            AND CONVERT(VARCHAR(10), b1.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                            AND b1.platform = 2
                            AND m1.status = 0
                    GROUP BY 
                            m1.OrderRegionOneId ,
                			m1.OrderRegionTwoId   
	</select>
	<!--商家端新模式下的今日订单 addby zhaohailong 20151030 -->
	<select id="queryTodayOrderTotal" parameterType="java.lang.Long"   resultType="com.edaisong.entity.domain.RegionOrderTotal">
     SELECT  a.id ,
        a.ParentId ,
        a.name ,
        ISNULL(SUM(mb.tb), 0) AS num
FROM    OrderRegion a ( NOLOCK )
        LEFT JOIN ( SELECT  1 AS tb ,
                            a.OrderRegionOneId ,
                            a.OrderRegionTwoId
                    FROM    [order] b ( NOLOCK )
                            JOIN OrderGrabChild m ( NOLOCK ) ON b.id = m.OrderId
                            JOIN OrderGrab a ( NOLOCK ) ON a.Id = m.GrabOrderId
                    WHERE   b.businessId = #{businessId}
                            AND CONVERT(VARCHAR(10), b.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                            AND a.OrderRegionOneId > 0
                            AND a.status IN ( 1, 2, 4 )
                    UNION ALL
                    SELECT  1 AS tb ,
                            m1.OrderRegionOneId ,
                            m1.OrderRegionTwoId
                    FROM    [order] b1 ( NOLOCK )
                            JOIN orderchild m1 ( NOLOCK ) ON b1.id = m1.orderid
                    WHERE   b1.businessId = #{businessId}
                            AND CONVERT(VARCHAR(10), b1.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
                            AND b1.platform = 2
                            AND m1.status = 0 
                  ) mb ON ( mb.OrderRegionTwoId = 0
                            AND a.Id = mb.OrderRegionOneId
                          )
                          OR ( mb.OrderRegionTwoId > 0
                               AND a.Id = mb.OrderRegionTwoId
                             )
WHERE   a.businessId = #{businessId}
        AND a.status = 1
GROUP BY a.id ,
        a.ParentId ,
        a.name  
	</select>
	<!--商家端新模式下给定区域下是否有处理中的订单addby zhaohailong 20151030 -->
	<select id="queryIngOrderByRegionId" parameterType="java.lang.Long"   resultType="java.lang.Long">
		  SELECT    COUNT(0) AS num
  FROM      dbo.[order] a ( NOLOCK )
            JOIN dbo.OrderChild b ( NOLOCK ) ON a.Id = b.OrderId
  WHERE     a.[Platform] = 2
            AND CONVERT(VARCHAR(10), a.PubDate, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
            AND ( b.OrderRegionOneId = #{regionId}
                  OR b.OrderRegionTwoId = #{regionId}
                )
            AND b.Status IN ( 0, 2, 4 )
	</select>
	
	
	<!-- 后台E单订单列表页面   查询列集合 add by caoheyang 20151124 -->
	<sql id="getShanSongOrdersColums">
		a.Id,a.OrderNo,a.PubDate,a.PickUpAddress,a.BusinessId,a.ReceviceAddress,ISNULL(a.ClienterId, 0) clienterId ,
                    a.PickupCode ,a.[Status],a.Amount,a.Weight,a. KM ,a.ReceiveCode,a.IsReceiveCode,
                    a.TipAmount,
        c.TrueName ClienterName,
        c.PhoneNo ClienterPhoneNo,
        b.PhoneNo BusinessPhoneNo 
	</sql>

	<!-- 后台E单订单列表页面 查询列集来源 add by caoheyang 20151124 -->
	<sql id="getShanSongOrdersFrom">
	   dbo.[order] (nolock)  a
        join business b with ( nolock ) on b.Id = a.businessId
        <if test="authCityStr !=null and authCityStr!=''">
        join [dbo].[Fn_SplitToTable](''${authCityStr}'') AS FS ON FS.Value=b.City
        </if>
        left join dbo.clienter (nolock) c on a.ClienterId = c.Id
        left join dbo.OrderOther d ( nolock ) on a.Id = d.OrderId
	</sql>
	<!--  后台E单订单列表页面 动态查询条件 add by caoheyang 20151124 -->
	<sql id="getShanSongOrdersColumsWhere">
		1=1 and a.[platform]=3 
		<if test="businessPhone != null and businessPhone!='' ">
			and b.PhoneNo=''${businessPhone}''
		</if>
		<if test="orderId != null and orderId!=''">
			and a.OrderNo=''${orderId}''
		</if>
		<if test="orderStatus != null and orderStatus!=-1">
			and a.Status=${orderStatus}
		</if>
		<if test="superManName != null and superManName!=''">
			and c.TrueName=''${superManName}''
		</if>
		<if test="superManPhone != null and superManPhone!='' ">
			and c.PhoneNo=''${superManPhone}''
		</if>
		<if test="businessCity != null and businessCity !=''">
			and b.city  = ''${businessCity}''
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and a.PubDate>= ''${orderPubStart} 00:00:00''
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND DATEADD(d, 1, ''${orderPubEnd}'')>a.PubDate
		</if>
	</sql>

	<!-- 后台E单订单列表页面 add by caoheyang 20151124 -->
	<select id="getShanSongOrders" resultType="com.edaisong.entity.domain.ShanSongOrderListModel"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' a.PubDate desc ',
		'
		<include refid="getShanSongOrdersColums" />
		',
		'
		<include refid="getShanSongOrdersFrom" />
		',
		'
		<include refid="getShanSongOrdersColumsWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
	
	<!-- 闪送导出订单 add by caoheyang 20151125 -->
	  <select id="exportShanSongOrder" resultType="com.edaisong.entity.domain.ExportShanSongOrder"
  		 parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
select 	 a.Id ,a.OrderNo ,a.PickUpAddress,a.BusinessId ,
   a.ReceviceAddress ,a.clienterId ,a.PickupCode ,
   a.[Status] ,a.Amount,a.Weight,a.KM,a.PubName,a.PubPhoneNo,a.RecevicePhoneNo,
   a.ReceviceName , CONVERT(VARCHAR(100),  a.[PubDate], 120) as PubDate,  e.PayType,
ISNULL(c.TrueName,'匿名') ClienterName,
ISNULL(  c.PhoneNo,'无') ClienterPhoneNo,
ISNULL( b.PhoneNo ,'无') BusinessPhoneNo 
from  dbo.[order] (nolock) a 
join dbo.OrderOther d ( nolock ) on a.Id = d.OrderId
join dbo.OrderChild e ( nolock ) on  a.Id=e.OrderId
join business b with ( nolock ) on b.Id = a.businessId and  a.[Platform]=3
left join dbo.clienter (nolock) c on a.ClienterId = c.Id
where 
1=1
		<if test="businessPhone != null and businessPhone!='' ">
			and b.PhoneNo='${businessPhone}'
		</if>
		<if test="orderId != null and orderId!=''">
			and a.OrderNo='${orderId}'
		</if>
		<if test="orderStatus != null and orderStatus!=-1">
			and a.Status=${orderStatus}
		</if>
		<if test="superManName != null and superManName!=''">
			and c.TrueName='${superManName}'
		</if>
		<if test="superManPhone != null and superManPhone!='' ">
			and c.PhoneNo='${superManPhone}'
		</if>
	    <if test="businessCity != null and businessCity !=''">
			and b.city  = '${businessCity}'
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and a.PubDate>= '${orderPubStart} 00:00:00'
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND DATEADD(d, 1, '${orderPubEnd}')>a.PubDate
		</if>
		<if test="authorityCityNameList != null">
			and b.city in
			<foreach item="item" index="index" collection="authorityCityNameList"
				open="(" separator="," close=")">
				'${item}'
			</foreach>
		</if>
  </select>
  	<!-- 后台E单订单详情页面 add by caoheyang 20151124 -->
<select id="getShanSongOrderByNo" resultType="com.edaisong.entity.domain.ShanSongOrderListModel"
		parameterType="java.lang.String">
select 	 a.Id ,a.OrderNo ,a.PickUpAddress,a.BusinessId ,a.ReceviceAddress ,a.clienterId ,a.PickupCode ,a.ReceiveCode,
a.[status],a.Amount,a.TipAmount, a.Weight,a.KM,a.PubName,a.PubPhoneNo,a.RecevicePhoneNo,
a.ReceviceName ,  a.[PubDate],
ISNULL(c.TrueName,'匿名') ClienterName,
ISNULL(  c.PhoneNo,'无') ClienterPhoneNo,
ISNULL( b.PhoneNo ,'无') BusinessPhoneNo ,a.Remark,a.ProductName,a.IsEnable 
from  dbo.[order] (nolock) a
join business b with ( nolock ) on b.Id = a.businessId and a.[Platform]=3
 join dbo.OrderOther d ( nolock ) on a.Id = d.OrderId 
left join dbo.clienter (nolock) c on a.ClienterId = c.Id
where a.orderno=#{ordernNo}
</select>
<!--闪送商家端我的任务 addby wangchao -->
	<select id="shanSongQueryOrderCountB" parameterType="com.edaisong.entity.req.QueryShanSongOrderReq"   resultType="com.edaisong.entity.resp.QueryOrderBResp">
	     select  ISNULL(SUM(CASE Status
              when 0 then 1
              else 0
            end),0) newCount ,
        ISNULL(SUM(CASE Status
              when 2 then 1
              else 0
            end),0) deliveryCount ,
        ISNULL(SUM(CASE Status
              when 4 then 1
              else 0
            end),0) takingCount,
        ISNULL(SUM(CASE Status
              when 50 then 1
              else 0
            end),0) waitPayCount ,
            ISNULL(SUM(CASE Status
              when 1 then 1
              else 0
            end),0) hadCompleteCount  
       from    dbo.[order] (nolock)
       where businessId=${businessId} and [Platform] IN(${platform}) 
	</select>
	<select id="shanSongQueryOrderB" resultType="com.edaisong.entity.domain.QueryOrder"
		parameterType="com.edaisong.entity.req.QueryShanSongOrderReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		'
		<if test="orderBy  ==0 ">
			o.PubDate desc
		</if>
		 <if test="orderBy  ==1 ">
			o.ActualDoneDate desc
		</if>
		',
		'
		<include refid="shanSongqueryOrderColums" />
		',
		'
		<include refid="shanSongqueryOrderFrom" />
		',
		'
		<include refid="shanSongqueryOrderWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
	<sql id="shanSongqueryOrderColums">
		 CONVERT(VARCHAR(16), o.ActualDoneDate, 120) as ActualDoneDate ,
        o.Amount ,
        o.OrderCount ,
        o.IsPay ,
        o.OrderNo ,
        o.PickUpAddress ,
        CONVERT(VARCHAR(16), o.PubDate, 120) as PubDate ,
        case   isnull(o.ReceviceAddress,'''')  
		when  '''' then ''附近3公里左右，由商户指定''
		else o.ReceviceAddress end as ReceviceAddress,
        o.ReceviceName ,
        o.RecevicePhoneNo ,
        o.ReceviceCity ,
        o.Remark ,
        o.Status ,
        o.ReceviceLongitude ,
        o.ReceviceLatitude ,
        b.Id as BusinessId ,
        b.Name as BusinessName ,
        b.PhoneNo as BusinessPhone ,
        b.PhoneNo2 as BusinessPhone2 , 
        c.TrueName as SuperManName ,
        b.balancePrice,
        c.PhoneNo as SuperManPhone ,
        o.OrderFrom ,
        o.id as OrderId ,
        o.MealsSettleMode ,
        b.Longitude ,
        b.Latitude ,
        REPLACE(b.City, ''市'', '''') as pickUpCity ,
        ( o.Amount + ISNULL(o.DistribSubsidy, 0) * ISNULL(o.OrderCount, 0) ) as TotalAmount ,
        ISNULL(o.OriginalOrderNo, '''') as OriginalOrderNo ,
        o.OrderCommission ,o.PubName,
        b.GroupId ,o.[Platform],isnull(o.KM,0) km,isnull(o.[Weight],0) weight,o.PickupCode,
        ISNULL(oo.HadUploadCount, 0) HadUploadCount ,isnull(g.GroupName,'''') as OrderFromName,
        ISNULL(o.amount,0)+ISNULL(o.tipamount,0) as amountAndTip,o.receivecode,
        o.IsReceiveCode,
case o.Payment when 0 then ''余额''  when 1 then ''支付宝''  when 2 then ''微信'' end paymentstr,
case o.Platform when 1 then ''E代送商户版''  when 2 then ''E代送智能调度''  when 3 then ''E代送'' end platformstr
	</sql>
	<!--   移动端 订单列表add by caoheyang 20150910 -->
	<sql id="shanSongqueryOrderFrom">
		 [order] (nolock) as o
        join dbo.OrderOther oo ( nolock ) on o.Id = oo.OrderId
        join business (nolock) as b on o.businessId = b.Id
        left join clienter (nolock) as c on o.clienterId = c.Id
        left join dbo.[group] (nolock) g on o.OrderFrom = g.Id
                                            and g.IsValid = 1 
	</sql>
	<!--   移动端 订单列表add by caoheyang 20150910 -->
	<sql id="shanSongqueryOrderWhere">
		1=1 and o.IsEnable=1  and o.[Platform]  IN( ${platform} ) 
	   <if test="clienterId != null and  clienterId !=0 ">
			and o.clienterId=${clienterId}
		</if> 
		<if test="businessId != null and  businessId !=0 ">
			and o.businessId=${businessId}
		</if> 
		 <if test="status != null"> 
			and o.status=${status} 
		</if> 
		<if test="dateInfo != null">
			and  CONVERT(VARCHAR(100), PubDate, 23)=''${dateInfo}''
		</if> 
	</sql>
	
	<!--集团中心订单列表页面  查询列集合 add by caoheyang 20160222 -->
	<sql id="getGroupOrdersColums">
		o.[Id] ,o.[OrderNo],o.[PickUpAddress] ,
		o.[PubDate] ,
		o.[ReceviceName]
		,o.[RecevicePhoneNo] ,o.[ReceviceAddress] ,
		 o.[Amount] , o.[OrderCommission] ,
		o.[Remark] ,
		o.[Status] , o.[clienterId] , o.[businessId] , o.[ReceviceCity] ,
	    o.[OrderFrom] ,
		o.[ReceiveProvince] , o.[ReceiveArea] , o.[ReceiveProvinceCode]
		,o.[ReceiveCityCode] ,o.[ReceiveAreaCode] ,o.SettleMoney,
		o.[OrderCount] ,o.[CommissionRate] ,
		c.TrueName ClienterName ,
		c.PhoneNo ClienterPhoneNo , b.Name BusinessName ,b.PhoneNo BusinessPhoneNo ,
		b.Address BusinessAddress ,
		o.[Adjustment] ,
		o.BusinessCommission,
        case when  d.GroupId=0 or d.GroupId is null then ''门店'' 
        else  ''集团''  end  as payBy
	</sql>

	<!-- 后台订单列表页面 查询列集来源 add by caoheyang 20160222 -->
	<sql id="getGroupOrdersFrom">
		[order] o with ( nolock )
		join dbo.OrderOther oo with ( nolock ) on o.Id = oo.OrderId
		join business b with ( nolock ) on b.Id = o.businessId  
		left join clienter c with ( nolock ) on c.Id = o.clienterId
		left join BusinessBalanceRecord d  with ( nolock ) on o.id = d.WithwardId and d.RecordType=1
	</sql>
	<!-- 集团中心订单列表页面  动态查询条件 add by caoheyang 20160222 -->
	<sql id="getGroupOrdersColumsWhere">
		1=1 and 3>=o.Platform  and o.GroupBusinessId =${groupBusinessId} and (o.OrderFrom=0 or o.OrderFrom=99)
		<if test="businessName != null and businessName != ''">
			and b.Name=''${businessName}''
		</if>
		<if test="businessID != null and businessID  != ''">
			and o.businessID=''${businessID}''
		</if>
		<if test="orderId != null and orderId!=''">
			and o.OrderNo=''${orderId}''
		</if>
		<if test="orderStatus != null and orderStatus>-1">
			and o.Status=${orderStatus}
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and o.PubDate>= ''${orderPubStart} 00:00:00''
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND ''${orderPubEnd}''>o.PubDate
		</if>
		<if test="authorityCityNameList != null">
			and b.city in
			<foreach item="item" index="index" collection="authorityCityNameList"
				open="(''" separator="'',''" close="'')">
				#{item}
			</foreach>
		</if>
	</sql>

	<!--集团中心订单列表页面 add by caoheyang 20160222 -->
	<select id="getGroupOrders" resultType="com.edaisong.entity.domain.OrderListModel"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' o.Status ASC,o.Id DESC ',
		'
		<include refid="getGroupOrdersColums" />
		',
		'
		<include refid="getGroupOrdersFrom" />
		',
		'
		<include refid="getGroupOrdersColumsWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
	
  <!--集团中心订单列表页面  导出 add by caoheyang 20160222 -->
	<select id="exportGroupOrders" resultType="com.edaisong.entity.domain.OrderListModel"
	parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
	select 
		 o.orderNo ,
        ISNULL(b.Name, '') businessName ,
         o.PubDate,oo.GrabTime,oo.TakeTime,o.ActualDoneDate,
        o.amount ,
        o.orderCount ,
        o.status ,
        ISNULL(c.TrueName, '匿名')+':'+ ISNULL(c.PhoneNo, '未知') clienterName ,
        o.settleMoney ,
        CASE when d.GroupId = 0
                  or d.GroupId is null then '门店'
             else '集团'
        end as payBy 
	  from  
       [order] o with ( nolock )
        join dbo.OrderOther oo with ( nolock ) on o.Id = oo.OrderId
        join business b with ( nolock ) on b.Id = o.businessId  
	 	left join clienter c with ( nolock ) on c.Id = o.clienterId
		left join BusinessBalanceRecord d  with ( nolock ) on o.id = d.WithwardId and d.RecordType=1
	 where  
	 1=1 and 3>=o.Platform  and o.GroupBusinessId =${groupBusinessId} and (o.OrderFrom=0 or o.OrderFrom=99)
		<if test="businessName != null and businessName != ''">
			and b.Name='${businessName}'
		</if>
		<if test="orderId != null and orderId!=''">
			and o.OrderNo='${orderId}'
		</if>
		<if test="orderStatus != null and orderStatus>-1">
			and o.Status=${orderStatus}
		</if>
		<if test="orderPubStart != null and orderPubStart!=''">
			and o.PubDate>= '${orderPubStart} 00:00:00'
		</if>
		<if test="orderPubEnd != null and orderPubEnd!=''">
		AND DATEADD(d, 1, '${orderPubEnd}')>o.PubDate
		</if>
		<if test="authorityCityNameList != null">
			and b.city in
			<foreach item="item" index="index" collection="authorityCityNameList"
				open="('" separator="','" close="')">
				#{item}
			</foreach>
		</if>
		 order by o.Status ASC,o.Id DESC 
	</select>
<!-- 集团首页  add by caoheyang 20160223 -->
	<select id="groupTodayStatistics" resultType="com.edaisong.entity.domain.GroupTodayStatistics"
	parameterType="java.lang.Integer">
declare @balancePrice NUMERIC(18,2); --集团当前余额
declare @todayPay NUMERIC(18,2); --集团今日支出金额
declare @todayDishTotal NUMERIC(18,2); --今日使用集团余额产生的餐品金额
set @balancePrice=0.00;
set @todayPay=0.00;
set @todayDishTotal=0.00;
select @balancePrice=ISNULL(Amount,0) from dbo.GroupBusiness (nolock) where Id=#{groupId}; -- 集团当前余额

select   @todayPay=ISNULL(SUM(CASE when a.MealsSettleMode = 1
                      and a.IsPay = 0 then a.SettleMoney - a.Amount
                 when a.MealsSettleMode = 1
                      and a.IsPay = 1 then a.SettleMoney
                 else 0
            end),0) ,@todayDishTotal=ISNULL(SUM(case  when a.MealsSettleMode = 1      --0已付款 1  未付款
                      and a.IsPay = 1 then a.Amount else 0 end ),0)
from    dbo.[order] (nolock) a
        join BusinessBalanceRecord (nolock) b on a.Id = b.WithwardId
                                                 and b.RecordType = 1
                                                 and b.Status = 1
where   CONVERT(VARCHAR(100), a.PubDate, 23) = CONVERT(VARCHAR(100), GETDATE(), 23)
        and a.Status != 3
        and a.GroupBusinessId = #{groupId};
        
select  @balancePrice as balancePrice ,
@todayPay as todayPay ,
@todayDishTotal as todayDishTotal 

	</select>
  <!-- 集团首页 订单数量 统计  caoheyang 20160223-->
  <select id="groupTodayOrderStatistics" resultMap="businessOrderSummaryResultMap"
	parameterType="java.util.Map">
		SELECT ISNULL(sum(CASE WHEN [Status]=1 THEN 1 ELSE 0 end),0)  AS 'finish',
		ISNULL(sum(CASE WHEN [Status]=2 THEN 1 ELSE 0 end),0) AS 'received', --待抢单
		ISNULL(sum(CASE WHEN [Status]=3 THEN 1 ELSE 0 end),0) AS 'cancel', --已完成
		ISNULL(sum(CASE WHEN [Status]=4 THEN 1 ELSE 0 end),0) AS 'pickUp', --已取消
		ISNULL(sum(CASE WHEN [Status]=0 THEN 1 ELSE 0 end),0) AS 'unReceive'--配送中
		FROM dbo.[order] (NOLOCK)
		 where 1=1 and  CONVERT(varchar(100), PubDate, 23)=CONVERT(varchar(100), GETDATE(), 23)
		<if test="businessId != null and businessId!=0">
		 and  businessId=#{businessId} 
		</if>
	    <if test="groupBusinessId != null and groupBusinessId!=0">
		 and  GroupBusinessId=#{groupBusinessId} 
		</if>
   	</select>	
   	  <!--集团首页 订单数量 统计 按小时统计  caoheyang 20160223-->
   	 <select id="groupTodayOrderStatisticsReport" resultType="com.edaisong.entity.domain.BusiPubOrderTimeStatisticsModel"
		parameterType="java.util.Map">
		SELECT SUM(OrderCount) as pubCount, DATENAME(HOUR,o.PubDate) AS hour,status
		FROM dbo.[order] (NOLOCK) o
		WHERE 1=1 AND
		CONVERT(varchar(100), PubDate, 23)=CONVERT(varchar(100), GETDATE(), 23)
	    <if test="businessId != null and businessId!=0">
		 and  businessId=#{businessId} 
		</if>
	    <if test="groupBusinessId != null and groupBusinessId!=0">
		 and  GroupBusinessId=#{groupBusinessId} 
		</if>
		GROUP BY status,DATENAME(HOUR,o.PubDate) ORDER BY hour;
	</select>
	 <!--集团订单统计  主数据  caoheyang 20160224-->
   	 <select id="groupOrderstatistics" resultType="com.edaisong.entity.domain.GroupOrderstatistics"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
		select  ISNULL(SUM(CASE Status
              when 1 then 1
              else 0
            end),0) as compliteCount,
        ISNULL(SUM(CASE Status
              when 3 then 1
              else 0
            end),0) as canelCount ,
        ISNULL(SUM(CASE Status
              when 1 then SettleMoney
              else 0
            end),0) totalSettleMoney,
        ISNULL(SUM(CASE Status
              when 1 then Amount
              else 0
            end),0) as totalAmount
from    dbo.[order] (nolock) o
where   1 = 1
        and PubDate >= '${orderPubStart}'
        and DATEADD(d, 1, '${orderPubEnd}')>o.PubDate
        and ( Status = 3
              or Status = 1
            )
          <if test="businessID != null and businessID!=0">
		                   and  businessId=#{businessID} 
		 </if>
        and GroupBusinessId = ${groupBusinessId}
        and ( o.OrderFrom = 0
              or o.OrderFrom = 99
            )
	</select>
	
	  <!--集团订单统计 每日统计  caoheyang 20160224-->
   	 <select id="groupOrderDaystatistics" resultType="com.edaisong.entity.domain.GroupOrderDaystatistics"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
		with  a as ( select   CONVERT(VARCHAR(100), DATEADD(dd, number, '${orderPubStart}'), 23) as monthDate
               from     master..spt_values
               where    type = 'P'
                        and DATEADD(d, 1, '${orderPubEnd}')>DATEADD(dd, number, '${orderPubStart}')  
             ),
        b as ( select   COUNT(1) as orderCount ,
                        CONVERT(VARCHAR(100), PubDate, 23) as pubDateStr,
                        SUM(SettleMoney) as SettleMoney,
                        SUM(Amount) as amount
               from     dbo.[order] (nolock) o
               where    1 = 1
                        and PubDate >= '${orderPubStart}'
                         and DATEADD(d, 1, '${orderPubEnd}')>o.PubDate
                        and Status = ${orderStatus}
                        and GroupBusinessId=${groupBusinessId}
                        and (o.OrderFrom=0 or o.OrderFrom=99)
                        <if test="businessID != null and businessID!=0">
		                   and  businessId=#{businessID} 
		                </if>
               group by CONVERT(VARCHAR(100), PubDate, 23)
             )
    select  a.monthDate ,
           ISNULL( b.orderCount,0) orderCount,
           ISNULL( b.SettleMoney,0) settleMoney,
           ISNULL( b.amount,0) amount
    from    a
            left join b on a.MonthDate = b.pubDateStr 
	</select>
	
	  <!--集团订单统计 每日统计  caoheyang 20160224-->
   	 <select id="exportStatistics" resultType="com.edaisong.entity.domain.ExportStatistics"
		parameterType="com.edaisong.entity.req.PagedOrderSearchReq">
select  CONVERT(VARCHAR(100), o.PubDate, 23) monthDate ,
        MIN(b.name) businessName ,
        ISNULL(SUM(CASE o.Status
                     when 1 then 1
                     else 0
                   end), 0) as compliteCount ,
        ISNULL(SUM(CASE o.Status
                     when 3 then 1
                     else 0
                   end), 0) as canelCount ,
        ISNULL(SUM(CASE o.Status
                     when 1 then SettleMoney
                     else 0
                   end), 0) totalSettleMoney ,
        ISNULL(SUM(CASE o.Status
                     when 1 then o.Amount
                     else 0
                   end), 0) as totalAmount ,
        ISNULL(SUM(CASE when o.Status = 1
                             and bb.GroupId != 0 then o.SettleMoney
                        else 0
                   end), 0) as groupPay ,
        ISNULL(SUM(CASE when o.Status = 1
                             and bb.GroupId = 0 then o.SettleMoney
                        else 0
                   end), 0) as businessPay
from    dbo.[order] (nolock) o
        join dbo.business (nolock) b on o.businessId = b.Id
        join dbo.BusinessBalanceRecord (nolock) bb on o.Id = bb.WithwardId
                                                      and bb.RecordType = 1
where   1 = 1
        and PubDate >= '${orderPubStart}'
         and DATEADD(d, 1, '${orderPubEnd}')>o.PubDate
        and ( o.Status = 3
              or o.Status = 1
            )
        and GroupBusinessId = ${groupBusinessId}
        <if test="businessID != null and businessID!=0">
		     and  o.businessId=#{businessID} 
	    </if>
        and ( o.OrderFrom = 0
              or o.OrderFrom = 99
            )
group by b.Name ,
        CONVERT(VARCHAR(100), o.PubDate, 23)
	</select>
	
</mapper>