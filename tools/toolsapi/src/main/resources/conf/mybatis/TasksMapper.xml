<?xml version="1.0" encoding="UTF-8"?>
 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="com.edaisong.toolsapi.dao.inter.ITasksDao">
 
    <resultMap type="com.edaisong.toolsentity.domain.Tasks" id="baseResultMap">
        <id property="id" column="Id" jdbcType="INTEGER"></id>
        <result property="priorityLevel" column="PriorityLevel" jdbcType="INTEGER" />
        <result property="type" column="Type" jdbcType="INTEGER" />
        <result property="userId" column="UserId" jdbcType="INTEGER" />
        <result property="user" column="User" jdbcType="NVARCHAR" />
        <result property="status" column="Status" jdbcType="INTEGER" />
        <result property="title" column="Title" jdbcType="NVARCHAR" />
        <result property="content" column="Content" jdbcType="NVARCHAR" />
        <result property="whoId" column="WhoId" jdbcType="INTEGER" />
        <result property="who" column="Who" jdbcType="NVARCHAR" />
        <result property="pubTime" column="PubTime" jdbcType="TIMESTAMP" />
        <result property="startTime" column="StartTime" jdbcType="TIMESTAMP" />
        <result property="taskTime" column="TaskTime" jdbcType="INTEGER" />
        <result property="completeTime" column="CompleteTime" jdbcType="TIMESTAMP" />
        <result property="isEnable" column="IsEnable" jdbcType="BIT" />
    </resultMap>
 
    <sql id="baseColumnList">
        t.Id,t.PriorityLevel,t.Type,t.UserId,t.[User],t.Status,t.Title,t.Content,
        t.WhoId,t.Who,t.PubTime,t.StartTime,t.TaskTime,t.CompleteTime,t.IsEnable
    </sql>
    
 
    <insert id="insert" parameterType="com.edaisong.toolsentity.domain.Tasks" useGeneratedKeys="true" keyProperty="id">
        insert into Tasks(PriorityLevel,Type,UserId,[User],Title,Content)
        values(
            #{priorityLevel,jdbcType=INTEGER},
            #{type,jdbcType=INTEGER},
            #{userId,jdbcType=INTEGER},
            #{user,jdbcType=NVARCHAR},
            #{title,jdbcType=NVARCHAR},
            #{content,jdbcType=NVARCHAR}
        )
    </insert>
 
    <update id="update" parameterType="com.edaisong.toolsentity.domain.Tasks">
        update Tasks
        set PriorityLevel=#{priorityLevel,jdbcType=INTEGER},
            Type=#{type,jdbcType=INTEGER},
            Title=#{title,jdbcType=NVARCHAR},
            Content=#{content,jdbcType=NVARCHAR}
        where Id=#{id,jdbcType=INTEGER}
    </update>
    
    <update id="toToDo" parameterType="java.lang.Integer">
    	update Tasks
		set [Status]=1,WhoId=0,Who='',StartTime=null,TaskTime=0
		where Id=#{id,jdbcType=INTEGER}
    </update>
    
    <update id="toToDoInProcess" parameterType="java.util.Map">
    	update Tasks
		set [Status]=#{status,jdbcType=INTEGER},
			WhoId=#{whoId,jdbcType=INTEGER},
			Who=#{who,jdbcType=NVARCHAR},
			StartTime=#{startTime,jdbcType=TIMESTAMP},
			TaskTime=#{taskTime,jdbcType=INTEGER},
			CompleteTime=null
		where Id=#{id,jdbcType=INTEGER}
    </update>
    
    <update id="toCompleted" parameterType="java.lang.Integer">
    	update Tasks set Status=3,CompleteTime=getdate() where Id=#{id,jdbcType=INTEGER}
    </update>
 
    <delete id="delete" parameterType="java.lang.Integer">
    	update Tasks set IsEnable=0 where Id=#{id,jdbcType=INTEGER}
    </delete>
 
    <select id="getById" resultMap="baseResultMap" parameterType="java.lang.Integer">
        select <include refid="baseColumnList"></include> from Tasks t(nolock) where Id=#{id,jdbcType=INTEGER}
    </select>
 
    <select id="getByUserId" resultMap="baseResultMap">
    	select <include refid="baseColumnList"></include>
		from Tasks t(nolock)
		where t.IsEnable=1
			and (t.Type=2 or (t.Type=1 and t.UserId=#{userId,jdbcType=INTEGER}))
    </select>
    
    <select id="select" resultMap="baseResultMap" parameterType="com.edaisong.toolsentity.req.TasksQueryReq">
    	select <include refid="baseColumnList"></include>
    	from Tasks t(nolock)
    	<include refid="selectWhere"></include>
    </select>
 
  	<sql id="selectWhere">
		where t.IsEnable=1
		<if test="userId>=0">
			and t.UserId=${userId}
		</if>
		<if test="type!=null and type!=''">
			and t.type =${type}
		</if>
		<choose>
			<when test="timeType==0">
				<if test="startTime!=null and startTime!=''">
					and t.PubTime >= '${startTime}'
				</if>
				<if test="endTime != null and endTime != ''">
					<![CDATA[and t.PubTime <= '${endTime}']]>
				</if>
			</when>
			<when test="timeType==1">
				<if test="startTime!=null and startTime!=''">
					and t.StartTime >= '${startTime}'
				</if>
				<if test="endTime != null and endTime != ''">
					<![CDATA[and t.StartTime <= '${endTime}']]>
				</if>
			</when>
			<when test="timeType==2">
				<if test="startTime!=null and startTime!=''">
					and dateadd(hh,t.TaskTime,t.StartTime) >= '${startTime}'
				</if>
				<if test="endTime != null and endTime != ''">
					<![CDATA[and dateadd(hh,t.TaskTime,t.StartTime) <= '${endTime}']]>
				</if>
			</when>
		</choose>
	</sql>
</mapper>